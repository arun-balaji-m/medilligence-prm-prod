<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medilligence â€¢ Pre-Assessment</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #f4f7fb;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.chat-container {
    width: 100%;
    max-width: 820px;
    height: 92vh;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-header {
    background: #2563eb;
    color: white;
    padding: 18px 24px;
}

.chat-header h1 {
    font-size: 20px;
    font-weight: 600;
}

.chat-header p {
    font-size: 13px;
    opacity: 0.9;
    margin-top: 4px;
}

.status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 50%;
    margin-right: 8px;
}

.patient-info {
    background: #f8fafc;
    padding: 14px 20px;
    border-bottom: 1px solid #e5e7eb;
    display: none;
}
.patient-info.active { display: block; }

.patient-info-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.patient-avatar {
    width: 44px;
    height: 44px;
    background: #2563eb;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
}

.patient-name {
    font-weight: 600;
    color: #1f2937;
}
.patient-meta {
    font-size: 12px;
    color: #6b7280;
}

.progress-bar {
    background: #f1f5f9;
    padding: 10px 20px;
    border-bottom: 1px solid #e5e7eb;
}
.progress-bar-fill {
    height: 6px;
    background: #2563eb;
    border-radius: 4px;
    width: 0%;
    transition: width 0.3s ease;
}
.progress-text {
    font-size: 12px;
    color: #6b7280;
    margin-top: 6px;
    text-align: center;
}

.chat-messages {
    flex: 1;
    padding: 22px;
    background: #f9fafb;
    overflow-y: auto;
}

.message {
    display: flex;
    margin-bottom: 14px;
}

.message.user { justify-content: flex-end; }
.message.assistant { justify-content: flex-start; }

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.message.assistant .message-content {
    background: #eef2f7;
    color: #1f2937;
    border-bottom-left-radius: 4px;
}

.message.user .message-content {
    background: #2563eb;
    color: white;
    border-bottom-right-radius: 4px;
}

.message-time {
    font-size: 11px;
    opacity: 0.6;
    margin-top: 6px;
}

.typing-indicator {
    display: none;
    gap: 6px;
    padding: 12px 20px;
}
.typing-indicator.active { display: flex; }

.typing-dot {
    width: 6px;
    height: 6px;
    background: #9ca3af;
    border-radius: 50%;
    animation: blink 1.4s infinite;
}
.typing-dot:nth-child(2) { animation-delay: .2s; }
.typing-dot:nth-child(3) { animation-delay: .4s; }

@keyframes blink {
    0%, 80%, 100% { opacity: 0.3; }
    40% { opacity: 1; }
}

.chat-input-container {
    padding: 14px 18px;
    border-top: 1px solid #e5e7eb;
    background: white;
}

.chat-input-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

.chat-input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 22px;
    border: 1px solid #d1d5db;
    font-size: 14px;
}

.chat-input:focus {
    outline: none;
    border-color: #2563eb;
}

.voice-button {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: 1px solid #d1d5db;
    background: white;
    color: #9ca3af;
    cursor: not-allowed;
}

.send-button {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: #2563eb;
    color: white;
    cursor: pointer;
    font-size: 16px;
}

.completion-card {
    background: #16a34a;
    color: white;
    padding: 22px;
    border-radius: 14px;
    text-align: center;
    margin: 18px 0;
}

.sections-collected {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-top: 14px;
}

.section-badge {
    background: rgba(255,255,255,0.25);
    padding: 6px;
    border-radius: 6px;
    font-size: 12px;
}

.reset-button {
    margin-top: 14px;
    padding: 10px 26px;
    border-radius: 22px;
    border: none;
    background: white;
    color: #16a34a;
    font-weight: 600;
    cursor: pointer;
}
</style>
</head>

<body>

<div class="chat-container">

    <div class="chat-header">
        <h1><span class="status-indicator"></span>Pre-Assessment Assistant</h1>
        <p>We'll collect some information before your doctor visit</p>
    </div>

    <div class="patient-info" id="patientInfo">
        <div class="patient-info-content">
            <div class="patient-avatar" id="patientAvatar">?</div>
            <div>
                <div class="patient-name" id="patientName">Guest</div>
                <div class="patient-meta" id="patientMeta">Please provide your mobile number to begin</div>
            </div>
        </div>
    </div>

    <div class="progress-bar">
        <div class="progress-bar-fill" id="progressBar"></div>
        <div class="progress-text" id="progressText">0 of 9 sections collected</div>
    </div>

    <div class="chat-messages" id="chatMessages">
        <div class="message assistant">
            <div class="message-content">
                <div>Hello! Welcome to our pre-assessment service.</div>
                <div style="margin-top:8px;">To get started, may I have your registered mobile number?</div>
            </div>
        </div>
    </div>

    <div class="typing-indicator" id="typingIndicator">
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
        <div class="typing-dot"></div>
    </div>

    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <button class="voice-button" id="voiceButton" disabled>ðŸŽ¤</button>
            <input type="text" class="chat-input" id="chatInput"
                   placeholder="Type your message hereâ€¦" autocomplete="off">
            <button class="send-button" id="sendButton">âž¤</button>
        </div>
    </div>

</div>

<script>
    let conversationHistory = [];
    let sessionData = {};
    let isProcessing = false;

    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const voiceButton = document.getElementById('voiceButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const patientInfo = document.getElementById('patientInfo');
    const patientAvatar = document.getElementById('patientAvatar');
    const patientName = document.getElementById('patientName');
    const patientMeta = document.getElementById('patientMeta');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    async function sendMessage() {
        const message = chatInput.value.trim();

        if (!message || isProcessing) return;

        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        isProcessing = true;

        addMessage('user', message);
        typingIndicator.classList.add('active');
        scrollToBottom();

        try {
            // Use relative path - will automatically work with gateway
            const response = await fetch('api/assessment/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    conversation_history: conversationHistory,
                    session_data: sessionData
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();

            conversationHistory.push(
                { role: 'user', content: message },
                { role: 'assistant', content: data.response }
            );

            sessionData = data.session_data;
            typingIndicator.classList.remove('active');
            addMessage('assistant', data.response);
            updateUI(data);

            if (data.is_complete) {
                showCompletionCard(data.assessment_id);
            }

        } catch (error) {
            console.error('Error details:', error);
            typingIndicator.classList.remove('active');

            let errorMessage = 'Sorry, I encountered an error. ';
            if (error.message) {
                errorMessage += error.message;
            } else {
                errorMessage += 'Please check if the server is running and try again.';
            }

            addMessage('assistant', errorMessage);
        } finally {
            chatInput.disabled = false;
            sendButton.disabled = false;
            isProcessing = false;
            chatInput.focus();
            scrollToBottom();
        }
    }

    function addMessage(role, content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';

        const textDiv = document.createElement('div');
        textDiv.textContent = content;

        const timeDiv = document.createElement('div');
        timeDiv.className = 'message-time';
        timeDiv.textContent = getCurrentTime();

        contentDiv.appendChild(textDiv);
        contentDiv.appendChild(timeDiv);
        messageDiv.appendChild(contentDiv);

        chatMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    function updateUI(data) {
        if (data.session_data.patient_verified) {
            patientInfo.classList.add('active');

            const name = data.session_data.patient_name || 'Patient';
            patientName.textContent = name;
            patientAvatar.textContent = name.charAt(0).toUpperCase();

            if (data.session_data.appointment_date) {
                patientMeta.textContent = `Appointment: ${data.session_data.appointment_date}`;
            } else {
                patientMeta.textContent = `MRN: ${data.session_data.patient_id || 'N/A'}`;
            }
        }

        const collectedSections = data.session_data.collected_sections || [];
        const totalSections = 9;
        const progress = (collectedSections.length / totalSections) * 100;

        progressBar.style.width = `${progress}%`;
        progressText.textContent = `${collectedSections.length} of ${totalSections} sections collected`;
    }

    function showCompletionCard(assessmentId) {
        const sections = [
            'Chief Complaint',
            'Present Illness',
            'Medical History',
            'Procedures',
            'Medications',
            'Allergies',
            'Comorbidities',
            'Family History',
            'Social History'
        ];

        const completionCard = document.createElement('div');
        completionCard.className = 'completion-card';
        completionCard.innerHTML = `
            <h3>Assessment Complete!</h3>
            <p>Thank you for providing all the information. Your doctor will review this before your visit.</p>
            <div class="sections-collected">
                ${sections.map(section => `
                    <div class="section-badge collected">${section}</div>
                `).join('')}
            </div>
            <button class="reset-button" onclick="resetConversation()">Start New Assessment</button>
        `;

        chatMessages.appendChild(completionCard);
        scrollToBottom();

        chatInput.disabled = true;
        sendButton.disabled = true;
    }

    async function resetConversation() {
        try {
            await fetch('api/assessment/reset-session', {
                method: 'POST'
            });

            conversationHistory = [];
            sessionData = {};

            chatMessages.innerHTML = `
                <div class="message assistant">
                    <div class="message-content">
                        <div>Hello! Welcome to our pre-assessment service.</div>
                        <div style="margin-top: 10px;">To get started, may I have your registered mobile number?</div>
                        <div class="message-time">${getCurrentTime()}</div>
                    </div>
                </div>
            `;

            patientInfo.classList.remove('active');
            progressBar.style.width = '0%';
            progressText.textContent = '0 of 9 sections collected';
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();

        } catch (error) {
            console.error('Error resetting session:', error);
        }
    }

    function getCurrentTime() {
        const now = new Date();
        return now.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
    }

    function scrollToBottom() {
        setTimeout(() => {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }

    window.addEventListener('load', () => {
        chatInput.focus();
    });
</script>

</body>
</html>