<!--<!DOCTYPE html>-->
<!--<html>-->
<!--<head>-->
<!--  <title>AI Medical Avatar</title>-->
<!--</head>-->
<!--<body>-->

<!--<h2>Medical Pre-Assessment</h2>-->

<!--<button onclick="start()">Start Conversation</button>-->

<!--<div id="avatar"></div>-->

<!--<script>-->
<!--let ws;-->
<!--let audioCtx;-->
<!--let processor;-->

<!--async function start() {-->
<!--  const res = await fetch("/start-avatar", { method: "POST" });-->
<!--  const data = await res.json();-->

<!--  // Tavus embed-->
<!--  const iframe = document.createElement("iframe");-->
<!--  iframe.src = data.conversation_url;-->
<!--  iframe.width = 640;-->
<!--  iframe.height = 480;-->
<!--  iframe.allow = "camera; microphone; autoplay";-->
<!--  document.getElementById("avatar").appendChild(iframe);-->


<!--  // STT-->
<!--  ws = new WebSocket("ws://localhost:8000/stt");-->

<!--  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });-->
<!--  audioCtx = new AudioContext();-->
<!--  const source = audioCtx.createMediaStreamSource(stream);-->
<!--  processor = audioCtx.createScriptProcessor(4096, 1, 1);-->

<!--  source.connect(processor);-->
<!--  processor.connect(audioCtx.destination);-->

<!--  processor.onaudioprocess = e => {-->
<!--    const audio = e.inputBuffer.getChannelData(0);-->
<!--    ws.send(floatTo16BitPCM(audio));-->
<!--  };-->
<!--}-->

<!--function floatTo16BitPCM(float32Array) {-->
<!--  const buffer = new ArrayBuffer(float32Array.length * 2);-->
<!--  const view = new DataView(buffer);-->
<!--  let offset = 0;-->
<!--  for (let i = 0; i < float32Array.length; i++, offset += 2) {-->
<!--    let s = Math.max(-1, Math.min(1, float32Array[i]));-->
<!--    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);-->
<!--  }-->
<!--  return buffer;-->
<!--}-->
<!--</script>-->

<!--</body>-->
<!--</html>-->


<!DOCTYPE html>
<html>
<head>
  <title>AI Medical Avatar</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }

    #start-screen {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: black;
      color: white;
      z-index: 10;
    }

    #start-screen button {
      padding: 16px 32px;
      font-size: 20px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
    }

    #avatar {
      position: absolute;
      inset: 0;
      display: none;
    }

    iframe {
      width: 100vw;
      height: 100vh;
      border: none;
    }
  </style>
</head>

<body>

<!-- Minimal start screen -->
<div id="start-screen">
  <h2>Medical Pre-Assessment</h2>
  <p>Speak naturally. No video required.</p>
  <button onclick="start()">Start</button>
</div>

<!-- Fullscreen avatar -->
<div id="avatar"></div>

<script>
let ws;
let audioCtx;
let processor;

async function start() {
  // Hide UI
  document.getElementById("start-screen").style.display = "none";
  document.getElementById("avatar").style.display = "block";

  // Start Tavus conversation
  const res = await fetch("/start-avatar", { method: "POST" });
  const data = await res.json();

  // Fullscreen Tavus avatar
  const iframe = document.createElement("iframe");
  iframe.src = data.conversation_url;
  iframe.allow = "microphone; autoplay"; // NOTE: no camera
  document.getElementById("avatar").appendChild(iframe);

  // Voice-only STT
  ws = new WebSocket("ws://localhost:8000/stt");

  const stream = await navigator.mediaDevices.getUserMedia({
    audio: true,
    video: false
  });

  audioCtx = new AudioContext({ sampleRate: 16000 });
  const source = audioCtx.createMediaStreamSource(stream);

  processor = audioCtx.createScriptProcessor(4096, 1, 1);
  source.connect(processor);
  processor.connect(audioCtx.destination);

  processor.onaudioprocess = e => {
    const audio = e.inputBuffer.getChannelData(0);
    if (ws.readyState === WebSocket.OPEN) {
      ws.send(floatTo16BitPCM(audio));
    }
  };
}

function floatTo16BitPCM(float32Array) {
  const buffer = new ArrayBuffer(float32Array.length * 2);
  const view = new DataView(buffer);
  let offset = 0;

  for (let i = 0; i < float32Array.length; i++, offset += 2) {
    let s = Math.max(-1, Math.min(1, float32Array[i]));
    view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7fff, true);
  }
  return buffer;
}
</script>

</body>
</html>
