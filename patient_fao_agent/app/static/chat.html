<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medilligence â€¢ AI Patient Education</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #f4f7fb;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.container {
    width: 90%;
    max-width: 820px;
    height: 92vh;
    background: white;
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.header {
    background: #2563eb;
    color: white;
    padding: 18px 24px;
    text-align: left;
}
.header h1 { font-size: 20px; font-weight: 600; }
.header p { font-size: 13px; opacity: 0.9; margin-top: 4px; }

.chat-section {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
}

.chat-info {
    padding: 10px 15px;
    background: #f1f5f9;
    font-size: 13px;
}

.messages {
    flex: 1;
    padding: 20px;
    background: #f9fafb;
    overflow-y: auto;
}

.message { display: flex; margin-bottom: 14px; }
.message.user { justify-content: flex-end; }
.message.bot { justify-content: flex-start; }

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.message.user .message-content {
    background: #2563eb;
    color: white;
    border-bottom-right-radius: 4px;
}

.message.bot .message-content {
    background: #eef2f7;
    color: #1f2937;
    border-bottom-left-radius: 4px;
}

.typing-indicator {
    display: flex;
    gap: 4px;
    padding: 8px 0;
}

.typing-indicator span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #94a3b8;
    animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-10px); }
}

.input-area {
    display: flex;
    gap: 10px;
    padding: 14px 16px;
    border-top: 1px solid #e5e7eb;
    background: white;
}

.input-area input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 22px;
    border: 1px solid #d1d5db;
}

.icon-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e0e7ff;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: #2563eb;
    display: flex;
    align-items: center;
    justify-content: center;
}

.send-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #2563eb;
    border: none;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.upload-area { display: none; }
#fileInput { display: none; }

.loading, .error, .success {
    font-size: 13px;
    padding: 6px 15px;
}
</style>
</head>

<body>

<div class="container">
    <div class="header">
        <h1>Medilligence</h1>
        <p>AI Patient Education</p>
    </div>

    <div class="chat-section" id="chatSection">
        <div class="chat-info" id="patientInfo"></div>

        <div class="messages" id="messages">
            <div class="message bot">
                <div class="message-content">
                    To keep your health information secure, please enter your registered mobile number to continue.
                </div>
            </div>
        </div>

        <div class="upload-area" style="display:none;">
            <button id="uploadBtn"></button>
            <input type="file" id="fileInput" accept=".pdf">
            <div id="uploadStatus"></div>
        </div>

        <div class="input-area">
            <button class="icon-btn" onclick="goToVoice()">
                ðŸŽ¤
            </button>

            <input type="text"
                   id="queryInput"
                   placeholder="Enter mobile number or ask a health questionâ€¦"
                   onkeypress="if(event.key==='Enter') sendQuery()">

            <button class="icon-btn"
                    onclick="document.getElementById('fileInput').click()">
               <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0z"/>
                </svg>
            </button>

            <button class="send-btn" onclick="sendQuery()">âž¤</button>
        </div>
    </div>
</div>

<script>
    let patientId = null;
    let patientName = null;
    let sessionId = null;

    window.onload = function() {
        patientId = sessionStorage.getItem('patientId');
        patientName = sessionStorage.getItem('patientName');

        if (patientId && patientName) {
            document.getElementById('patientInfo').innerHTML =
                `<strong>Welcome back, ${patientName}!</strong> Ask questions or upload your medical documents.`;
            addMessage('bot', 'Hello! I can help explain your medical documents and answer health questions. How can I assist you today?');
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', uploadDocument);
        }
    });

    function goToVoice() {
        window.location.href = "./static/voice.html";
    }

    function isMobileNumber(text) {
        return /^\d{10}$/.test(text.trim());
    }

    async function sendQuery() {
        const input = document.getElementById('queryInput');
        const query = input.value.trim();

        if (!query) return;


        if (!patientId && isMobileNumber(query)) {
            // This is a mobile number - verify patient
            await verifyPatientByMobile(query);
            input.value = '';
            return;
        }


        if (!patientId) {
            addMessage('bot', 'Please enter your registered mobile number first to start chatting.');
            input.value = '';
            return;
        }


        addMessage('user', query);
        input.value = '';

        const typingId = addTypingIndicator();

        try {
            const payload = {
                patient_id: parseInt(patientId),
                query: query,
                session_id: sessionId || null
            };

            const response = await fetch('api/v1/chat/query', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                console.error('Error details:', data);
                removeTypingIndicator(typingId);
                addMessage('bot', 'Error: ' + (data.detail || 'Unknown error'));
                return;
            }

            removeTypingIndicator(typingId);
            sessionId = data.session_id;
            addMessage('bot', data.response);
        } catch (error) {
            removeTypingIndicator(typingId);
            addMessage('bot', 'Sorry, I encountered an error. Please try again.');
            console.error('Query error:', error);
        }
    }

    async function verifyPatientByMobile(mobile) {
        addMessage('user', mobile);
        const typingId = addTypingIndicator();

        try {
            const response = await fetch('api/v1/verify-patient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mobile_number: mobile })
            });

            const data = await response.json();
            removeTypingIndicator(typingId);

            if (data.verified) {
                patientId = data.patient_id;
                patientName = data.patient_name;

                // Store in session
                sessionStorage.setItem('patientId', patientId);
                sessionStorage.setItem('patientName', patientName);

                document.getElementById('patientInfo').innerHTML =
                    `<strong>Welcome, ${patientName}!</strong> Ask questions or upload your medical documents.`;

                addMessage('bot', `Verification successful! Hello ${patientName}, I can help explain your medical documents and answer health questions. How can I assist you today?`);
            } else {
                addMessage('bot', `${data.message}. Please try again with a registered mobile number.`);
            }
        } catch (error) {
            removeTypingIndicator(typingId);
            addMessage('bot', 'Error verifying patient. Please try again.');
            console.error('Verification error:', error);
        }
    }

    async function uploadDocument(event) {
        const file = event.target.files[0];
        const statusDiv = document.getElementById('uploadStatus');
        const uploadBtn = document.getElementById('uploadBtn');

        if (!file) return;

        if (!patientId) {
            alert('Please verify your mobile number first!');
            event.target.value = '';
            return;
        }

        if (file.type !== 'application/pdf') {
            statusDiv.innerHTML = '<p class="error">Please upload a PDF file only</p>';
            event.target.value = '';
            return;
        }

        if (file.size > 10 * 1024 * 1024) {
            statusDiv.innerHTML = '<p class="error">File size must be less than 10MB</p>';
            event.target.value = '';
            return;
        }

        uploadBtn.disabled = true;
        addMessage('user', `Uploaded: ${file.name}`);
        updateUploadStatus(statusDiv, 'Uploading document...', 'loading');

        const formData = new FormData();
        formData.append('file', file);
        formData.append('patient_id', patientId);

        try {
            setTimeout(() => updateUploadStatus(statusDiv, 'Extracting text from PDF...', 'loading'), 500);

            const response = await fetch('api/v1/chat/upload-document', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (!response.ok) {
                const errorMsg = data.detail || `Upload failed: ${response.status}`;
                updateUploadStatus(statusDiv, `${errorMsg}`, 'error');
                console.error('Backend error:', data);
                setTimeout(() => statusDiv.innerHTML = '', 8000);
                uploadBtn.disabled = false;
                event.target.value = '';
                return;
            }

            if (data.success) {
                updateUploadStatus(statusDiv, 'Converting to standard format...', 'loading');
                await sleep(800);
                updateUploadStatus(statusDiv, 'Generating patient-friendly explanation...', 'loading');
                await sleep(1000);
                updateUploadStatus(statusDiv, 'Document processed successfully!', 'success');
                addMessage('bot', data.explanation);
                setTimeout(() => statusDiv.innerHTML = '', 5000);
            } else {
                updateUploadStatus(statusDiv, `${data.message}`, 'error');
                setTimeout(() => statusDiv.innerHTML = '', 5000);
            }
        } catch (error) {
            updateUploadStatus(statusDiv, 'Error uploading document. Please try again.', 'error');
            console.error('Upload error:', error);
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        } finally {
            uploadBtn.disabled = false;
            event.target.value = '';
        }
    }

    function updateUploadStatus(statusDiv, message, type) {
        const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';
        statusDiv.innerHTML = `<p class="${className}">${message}</p>`;
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    function addMessage(type, text) {
        const messagesDiv = document.getElementById('messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type}`;
        messageDiv.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
        messagesDiv.appendChild(messageDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function addTypingIndicator() {
        const messagesDiv = document.getElementById('messages');
        const typingDiv = document.createElement('div');
        const typingId = 'typing-' + Date.now();
        typingDiv.id = typingId;
        typingDiv.className = 'message bot';
        typingDiv.innerHTML = '<div class="message-content"><div class="typing-indicator"><span></span><span></span><span></span></div></div>';
        messagesDiv.appendChild(typingDiv);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        return typingId;
    }

    function removeTypingIndicator(typingId) {
        const typingDiv = document.getElementById(typingId);
        if (typingDiv) {
            typingDiv.remove();
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>

</body>
</html>
