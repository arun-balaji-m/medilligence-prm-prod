<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>AI Patient Education - Voice Assistant</title>-->
<!--    <style>-->
<!--        * { margin: 0; padding: 0; box-sizing: border-box; }-->
<!--        body {-->
<!--            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            height: 100vh;-->
<!--            display: flex;-->
<!--            justify-content: center;-->
<!--            align-items: center;-->
<!--        }-->
<!--        .container {-->
<!--            width: 90%;-->
<!--            max-width: 800px;-->
<!--            height: 90vh;-->
<!--            background: white;-->
<!--            border-radius: 20px;-->
<!--            box-shadow: 0 20px 60px rgba(0,0,0,0.3);-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--            overflow: hidden;-->
<!--        }-->
<!--        .header {-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            color: white;-->
<!--            padding: 20px;-->
<!--            text-align: center;-->
<!--            flex-shrink: 0;-->
<!--        }-->
<!--        .header h1 { font-size: 24px; margin-bottom: 5px; }-->
<!--        .header p { font-size: 14px; opacity: 0.9; }-->
<!--        .mode-switch {-->
<!--            display: flex;-->
<!--            justify-content: center;-->
<!--            gap: 10px;-->
<!--            margin-top: 15px;-->
<!--        }-->
<!--        .mode-btn {-->
<!--            padding: 8px 20px;-->
<!--            border: 2px solid white;-->
<!--            background: transparent;-->
<!--            color: white;-->
<!--            border-radius: 20px;-->
<!--            cursor: pointer;-->
<!--            transition: all 0.3s;-->
<!--        }-->
<!--        .mode-btn.active {-->
<!--            background: white;-->
<!--            color: #667eea;-->
<!--        }-->
<!--        .verify-section {-->
<!--            padding: 20px;-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--            gap: 15px;-->
<!--            align-items: center;-->
<!--            justify-content: center;-->
<!--            flex: 1;-->
<!--        }-->
<!--        .input-group {-->
<!--            width: 100%;-->
<!--            max-width: 400px;-->
<!--        }-->
<!--        .input-group label {-->
<!--            display: block;-->
<!--            margin-bottom: 8px;-->
<!--            color: #333;-->
<!--            font-weight: 500;-->
<!--        }-->
<!--        .input-group input {-->
<!--            width: 100%;-->
<!--            padding: 12px;-->
<!--            border: 2px solid #ddd;-->
<!--            border-radius: 8px;-->
<!--            font-size: 16px;-->
<!--        }-->
<!--        .btn {-->
<!--            padding: 12px 30px;-->
<!--            border: none;-->
<!--            border-radius: 8px;-->
<!--            font-size: 16px;-->
<!--            cursor: pointer;-->
<!--            transition: all 0.3s;-->
<!--        }-->
<!--        .btn-primary {-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            color: white;-->
<!--        }-->
<!--        .btn-primary:hover { transform: translateY(-2px); }-->
<!--        .voice-section {-->
<!--            display: none;-->
<!--            flex-direction: column;-->
<!--            flex: 1;-->
<!--            min-height: 0;-->
<!--            padding: 0;-->
<!--        }-->
<!--        .patient-info {-->
<!--            background: #f8f9fa;-->
<!--            padding: 10px 15px;-->
<!--            font-size: 14px;-->
<!--            flex-shrink: 0;-->
<!--        }-->
<!--        .conversation {-->
<!--            flex: 1;-->
<!--            overflow-y: auto;-->
<!--            padding: 20px;-->
<!--            background: #f8f9fa;-->
<!--            min-height: 0;-->
<!--        }-->
<!--        .message {-->
<!--            margin-bottom: 15px;-->
<!--            display: flex;-->
<!--            gap: 10px;-->
<!--            animation: slideIn 0.3s ease;-->
<!--        }-->
<!--        @keyframes slideIn {-->
<!--            from { opacity: 0; transform: translateY(10px); }-->
<!--            to { opacity: 1; transform: translateY(0); }-->
<!--        }-->
<!--        .message.user { justify-content: flex-end; }-->
<!--        .message-content {-->
<!--            max-width: 70%;-->
<!--            padding: 12px 16px;-->
<!--            border-radius: 12px;-->
<!--            line-height: 1.5;-->
<!--            white-space: pre-wrap;-->
<!--            word-wrap: break-word;-->
<!--        }-->
<!--        .message.assistant .message-content {-->
<!--            background: white;-->
<!--            color: #333;-->
<!--            box-shadow: 0 2px 5px rgba(0,0,0,0.1);-->
<!--        }-->
<!--        .message.user .message-content {-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            color: white;-->
<!--        }-->
<!--        .voice-controls {-->
<!--            padding: 30px;-->
<!--            background: white;-->
<!--            display: flex;-->
<!--            flex-direction: column;-->
<!--            align-items: center;-->
<!--            gap: 20px;-->
<!--            flex-shrink: 0;-->
<!--        }-->
<!--        .mic-button {-->
<!--            width: 100px;-->
<!--            height: 100px;-->
<!--            border-radius: 50%;-->
<!--            border: none;-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            color: white;-->
<!--            font-size: 40px;-->
<!--            cursor: pointer;-->
<!--            transition: all 0.3s;-->
<!--            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);-->
<!--            display: flex;-->
<!--            align-items: center;-->
<!--            justify-content: center;-->
<!--        }-->
<!--        .mic-button:hover {-->
<!--            transform: scale(1.05);-->
<!--            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);-->
<!--        }-->
<!--        .mic-button:disabled {-->
<!--            background: #ccc;-->
<!--            cursor: not-allowed;-->
<!--            box-shadow: none;-->
<!--        }-->
<!--        .mic-button.listening {-->
<!--            animation: pulse 1.5s infinite;-->
<!--            background: #dc3545;-->
<!--        }-->
<!--        @keyframes pulse {-->
<!--            0%, 100% { transform: scale(1); box-shadow: 0 5px 20px rgba(220, 53, 69, 0.3); }-->
<!--            50% { transform: scale(1.05); box-shadow: 0 8px 30px rgba(220, 53, 69, 0.5); }-->
<!--        }-->
<!--        .status-text {-->
<!--            font-size: 16px;-->
<!--            color: #666;-->
<!--            min-height: 24px;-->
<!--            text-align: center;-->
<!--        }-->
<!--        .upload-area {-->
<!--            padding: 15px;-->
<!--            background: #f8f9fa;-->
<!--            border-top: 1px solid #ddd;-->
<!--            text-align: center;-->
<!--            flex-shrink: 0;-->
<!--        }-->
<!--        .file-input-wrapper {-->
<!--            position: relative;-->
<!--            display: inline-block;-->
<!--        }-->
<!--        .file-input-wrapper input[type=file] {-->
<!--            position: absolute;-->
<!--            opacity: 0;-->
<!--            width: 100%;-->
<!--            height: 100%;-->
<!--            cursor: pointer;-->
<!--            left: 0;-->
<!--            top: 0;-->
<!--        }-->
<!--        .transcript-preview {-->
<!--            min-height: 60px;-->
<!--            padding: 15px;-->
<!--            background: #f8f9fa;-->
<!--            border-radius: 8px;-->
<!--            width: 100%;-->
<!--            max-width: 600px;-->
<!--            font-size: 14px;-->
<!--            color: #333;-->
<!--            font-style: italic;-->
<!--        }-->
<!--        .error { color: #dc3545; padding: 10px; text-align: center; }-->
<!--        .loading { color: #666; padding: 10px; text-align: center; font-style: italic; }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--    <div class="container">-->
<!--        <div class="header">-->
<!--            <h1>üè• AI Patient Education</h1>-->
<!--            <p>Voice-powered health assistant</p>-->
<!--            <div class="mode-switch">-->
<!--                <button class="mode-btn active" onclick="switchMode('voice')">üé§ Voice</button>-->
<!--                <button class="mode-btn" onclick="window.location.href='/static/chat.html'">üí¨ Chat</button>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Verification Section &ndash;&gt;-->
<!--        <div class="verify-section" id="verifySection">-->
<!--            <div class="input-group">-->
<!--                <label for="mobileNumber">Enter your mobile number</label>-->
<!--                <input type="tel" id="mobileNumber" placeholder="+91 1234567890" />-->
<!--            </div>-->
<!--            <button class="btn btn-primary" onclick="verifyPatient()">Verify & Continue</button>-->
<!--            <div id="verifyMessage"></div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Voice Section &ndash;&gt;-->
<!--        <div class="voice-section" id="voiceSection">-->
<!--            <div class="patient-info" id="patientInfo"></div>-->
<!--            <div class="conversation" id="conversation"></div>-->
<!--            <div class="upload-area">-->
<!--                <div class="file-input-wrapper">-->
<!--                    <button class="btn btn-primary" id="uploadBtn">üìÑ Upload Medical Document (PDF)</button>-->
<!--                    <input type="file" id="fileInput" accept=".pdf" />-->
<!--                </div>-->
<!--                <div id="uploadStatus"></div>-->
<!--            </div>-->
<!--            <div class="voice-controls">-->
<!--                <div class="transcript-preview" id="transcriptPreview">Your words will appear here...</div>-->
<!--                <button class="mic-button" id="micButton" disabled onclick="toggleMic()">-->
<!--                    üé§-->
<!--                </button>-->
<!--                <div class="status-text" id="statusText">Initializing...</div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--        let patientId = null;-->
<!--        let patientName = null;-->
<!--        let ws = null;-->
<!--        let mediaRecorder = null;-->
<!--        let audioContext = null;-->
<!--        let isListening = false;-->
<!--        let audioQueue = [];-->
<!--        let isPlayingAudio = false;-->

<!--        // Setup file input listener-->
<!--        document.addEventListener('DOMContentLoaded', function() {-->
<!--            const fileInput = document.getElementById('fileInput');-->
<!--            if (fileInput) {-->
<!--                fileInput.addEventListener('change', uploadDocument);-->
<!--            }-->
<!--        });-->

<!--        function switchMode(mode) {-->
<!--            if (mode === 'chat') {-->
<!--                window.location.href = '/static/chat.html';-->
<!--            }-->
<!--        }-->

<!--        async function verifyPatient() {-->
<!--            const mobile = document.getElementById('mobileNumber').value;-->
<!--            const msgDiv = document.getElementById('verifyMessage');-->

<!--            if (!mobile) {-->
<!--                msgDiv.innerHTML = '<p class="error">Please enter mobile number</p>';-->
<!--                return;-->
<!--            }-->

<!--            msgDiv.innerHTML = '<p class="loading">Verifying...</p>';-->

<!--            try {-->
<!--                const response = await fetch('/api/v1/verify-patient', {-->
<!--                    method: 'POST',-->
<!--                    headers: { 'Content-Type': 'application/json' },-->
<!--                    body: JSON.stringify({ mobile_number: mobile })-->
<!--                });-->

<!--                const data = await response.json();-->

<!--                if (data.verified) {-->
<!--                    patientId = data.patient_id;-->
<!--                    patientName = data.patient_name;-->
<!--                    document.getElementById('verifySection').style.display = 'none';-->
<!--                    document.getElementById('voiceSection').style.display = 'flex';-->
<!--                    document.getElementById('patientInfo').innerHTML =-->
<!--                        `<strong>Welcome, ${patientName}!</strong> Speak naturally - I'm listening.`;-->

<!--                    await initializeVoice();-->
<!--                } else {-->
<!--                    msgDiv.innerHTML = `<p class="error">${data.message}</p>`;-->
<!--                }-->
<!--            } catch (error) {-->
<!--                msgDiv.innerHTML = '<p class="error">Error verifying patient. Please try again.</p>';-->
<!--                console.error('Verification error:', error);-->
<!--            }-->
<!--        }-->

<!--        async function initializeVoice() {-->
<!--            try {-->
<!--                updateStatus('Requesting microphone access...');-->

<!--                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });-->

<!--                // Initialize audio context-->
<!--                audioContext = new (window.AudioContext || window.webkitAudioContext)();-->

<!--                // Setup WebSocket-->
<!--                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';-->
<!--                const wsUrl = `${protocol}//${window.location.host}/api/v1/ws/voice/${patientId}`;-->

<!--                ws = new WebSocket(wsUrl);-->

<!--                ws.onopen = () => {-->
<!--                    console.log('WebSocket connected');-->
<!--                    setupMediaRecorder(stream);-->
<!--                };-->

<!--                ws.onmessage = async (event) => {-->
<!--                    if (event.data instanceof Blob) {-->
<!--                        // Received audio-->
<!--                        audioQueue.push(event.data);-->
<!--                        if (!isPlayingAudio) {-->
<!--                            playNextAudio();-->
<!--                        }-->
<!--                    } else {-->
<!--                        const data = JSON.parse(event.data);-->
<!--                        handleWebSocketMessage(data);-->
<!--                    }-->
<!--                };-->

<!--                ws.onerror = (error) => {-->
<!--                    console.error('WebSocket error:', error);-->
<!--                    updateStatus('Connection error');-->
<!--                };-->

<!--                ws.onclose = () => {-->
<!--                    console.log('WebSocket closed');-->
<!--                    updateStatus('Disconnected');-->
<!--                    document.getElementById('micButton').disabled = true;-->
<!--                };-->

<!--            } catch (error) {-->
<!--                console.error('Initialization error:', error);-->
<!--                updateStatus('Failed to access microphone');-->
<!--            }-->
<!--        }-->

<!--        function setupMediaRecorder(stream) {-->
<!--            mediaRecorder = new MediaRecorder(stream, {-->
<!--                mimeType: 'audio/webm'-->
<!--            });-->

<!--            mediaRecorder.ondataavailable = (event) => {-->
<!--                if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {-->
<!--                    ws.send(event.data);-->
<!--                }-->
<!--            };-->

<!--            mediaRecorder.onstart = () => {-->
<!--                console.log('Recording started');-->
<!--            };-->

<!--            mediaRecorder.onstop = () => {-->
<!--                console.log('Recording stopped');-->
<!--            };-->
<!--        }-->

<!--        function handleWebSocketMessage(data) {-->
<!--            console.log('Message:', data);-->

<!--            switch(data.type) {-->
<!--                case 'status':-->
<!--                    updateStatus(data.message);-->
<!--                    if (data.message === 'Listening...') {-->
<!--                        enableMic();-->
<!--                    }-->
<!--                    break;-->

<!--                case 'interim_transcript':-->
<!--                    document.getElementById('transcriptPreview').textContent = data.text;-->
<!--                    break;-->

<!--                case 'transcript':-->
<!--                    document.getElementById('transcriptPreview').textContent = 'Processing...';-->
<!--                    addMessage('user', data.text);-->
<!--                    break;-->

<!--                case 'response':-->
<!--                    addMessage('assistant', data.text);-->
<!--                    break;-->

<!--                case 'audio_complete':-->
<!--                    // Audio received completely-->
<!--                    break;-->

<!--                case 'speech_started':-->
<!--                    console.log('User started speaking');-->
<!--                    break;-->
<!--            }-->
<!--        }-->

<!--        async function playNextAudio() {-->
<!--            if (audioQueue.length === 0) {-->
<!--                isPlayingAudio = false;-->
<!--                return;-->
<!--            }-->

<!--            isPlayingAudio = true;-->
<!--            const audioBlob = audioQueue.shift();-->

<!--            try {-->
<!--                const arrayBuffer = await audioBlob.arrayBuffer();-->
<!--                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);-->

<!--                const source = audioContext.createBufferSource();-->
<!--                source.buffer = audioBuffer;-->
<!--                source.connect(audioContext.destination);-->

<!--                source.onended = () => {-->
<!--                    playNextAudio();-->
<!--                };-->

<!--                source.start(0);-->
<!--            } catch (error) {-->
<!--                console.error('Error playing audio:', error);-->
<!--                playNextAudio();-->
<!--            }-->
<!--        }-->

<!--        function toggleMic() {-->
<!--            if (!isListening) {-->
<!--                startListening();-->
<!--            } else {-->
<!--                stopListening();-->
<!--            }-->
<!--        }-->

<!--        function startListening() {-->
<!--            if (mediaRecorder && mediaRecorder.state === 'inactive') {-->
<!--                mediaRecorder.start(100); // Send data every 100ms-->
<!--                isListening = true;-->
<!--                document.getElementById('micButton').classList.add('listening');-->
<!--                document.getElementById('transcriptPreview').textContent = 'Listening...';-->
<!--                updateStatus('Speak now...');-->
<!--            }-->
<!--        }-->

<!--        function stopListening() {-->
<!--            if (mediaRecorder && mediaRecorder.state === 'recording') {-->
<!--                mediaRecorder.stop();-->
<!--                isListening = false;-->
<!--                document.getElementById('micButton').classList.remove('listening');-->
<!--                updateStatus('Processing...');-->
<!--            }-->
<!--        }-->

<!--        function enableMic() {-->
<!--            const micButton = document.getElementById('micButton');-->
<!--            micButton.disabled = false;-->
<!--            document.getElementById('transcriptPreview').textContent = 'Click microphone to speak...';-->
<!--        }-->

<!--        function updateStatus(message) {-->
<!--            document.getElementById('statusText').textContent = message;-->
<!--        }-->

<!--        function addMessage(type, text) {-->
<!--            const conversation = document.getElementById('conversation');-->
<!--            const messageDiv = document.createElement('div');-->
<!--            messageDiv.className = `message ${type}`;-->
<!--            messageDiv.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;-->
<!--            conversation.appendChild(messageDiv);-->
<!--            conversation.scrollTop = conversation.scrollHeight;-->
<!--        }-->

<!--        function escapeHtml(text) {-->
<!--            const div = document.createElement('div');-->
<!--            div.textContent = text;-->
<!--            return div.innerHTML;-->
<!--        }-->

<!--        async function uploadDocument(event) {-->
<!--            const file = event.target.files[0];-->
<!--            const statusDiv = document.getElementById('uploadStatus');-->
<!--            const uploadBtn = document.getElementById('uploadBtn');-->

<!--            if (!file) return;-->

<!--            if (file.type !== 'application/pdf') {-->
<!--                statusDiv.innerHTML = '<p class="error">Please upload a PDF file only</p>';-->
<!--                event.target.value = '';-->
<!--                return;-->
<!--            }-->

<!--            if (file.size > 10 * 1024 * 1024) {-->
<!--                statusDiv.innerHTML = '<p class="error">File size must be less than 10MB</p>';-->
<!--                event.target.value = '';-->
<!--                return;-->
<!--            }-->

<!--            uploadBtn.disabled = true;-->
<!--            addMessage('user', `üìÑ Uploaded: ${file.name}`);-->

<!--            updateUploadStatus(statusDiv, '‚¨ÜÔ∏è Uploading document...', 'loading');-->

<!--            const formData = new FormData();-->
<!--            formData.append('file', file);-->
<!--            formData.append('patient_id', patientId);-->

<!--            try {-->
<!--                setTimeout(() => updateUploadStatus(statusDiv, 'üìÑ Extracting text from PDF...', 'loading'), 500);-->

<!--                const response = await fetch('/api/v1/chat/upload-document', {-->
<!--                    method: 'POST',-->
<!--                    body: formData-->
<!--                });-->

<!--                if (!response.ok) {-->
<!--                    const data = await response.json();-->
<!--                    const errorMsg = data.detail || `Upload failed: ${response.status}`;-->
<!--                    updateUploadStatus(statusDiv, `‚ùå ${errorMsg}`, 'error');-->
<!--                    console.error('Backend error:', data);-->
<!--                    setTimeout(() => statusDiv.innerHTML = '', 8000);-->
<!--                    uploadBtn.disabled = false;-->
<!--                    event.target.value = '';-->
<!--                    return;-->
<!--                }-->

<!--                const data = await response.json();-->

<!--                if (data.success) {-->
<!--                    updateUploadStatus(statusDiv, 'üîÑ Converting to standard format...', 'loading');-->
<!--                    await sleep(800);-->

<!--                    updateUploadStatus(statusDiv, 'ü§ñ Generating patient-friendly explanation...', 'loading');-->
<!--                    await sleep(1000);-->

<!--                    updateUploadStatus(statusDiv, '‚úì Document processed successfully!', 'success');-->
<!--                    addMessage('assistant', data.explanation);-->

<!--                    setTimeout(() => statusDiv.innerHTML = '', 5000);-->
<!--                } else {-->
<!--                    updateUploadStatus(statusDiv, `‚ùå ${data.message}`, 'error');-->
<!--                    setTimeout(() => statusDiv.innerHTML = '', 5000);-->
<!--                }-->
<!--            } catch (error) {-->
<!--                updateUploadStatus(statusDiv, '‚ùå Error uploading document. Please try again.', 'error');-->
<!--                console.error('Upload error:', error);-->
<!--                setTimeout(() => statusDiv.innerHTML = '', 5000);-->
<!--            } finally {-->
<!--                uploadBtn.disabled = false;-->
<!--                event.target.value = '';-->
<!--            }-->
<!--        }-->

<!--        function updateUploadStatus(statusDiv, message, type) {-->
<!--            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';-->
<!--            statusDiv.innerHTML = `<p class="${className}">${message}</p>`;-->
<!--        }-->

<!--        function sleep(ms) {-->
<!--            return new Promise(resolve => setTimeout(resolve, ms));-->
<!--        }-->

<!--        // Cleanup on page unload-->
<!--        window.addEventListener('beforeunload', () => {-->
<!--            if (ws) {-->
<!--                ws.close();-->
<!--            }-->
<!--            if (mediaRecorder && mediaRecorder.state === 'recording') {-->
<!--                mediaRecorder.stop();-->
<!--            }-->
<!--        });-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->


<!--new ui generated by chatgpt-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Medilligence ‚Ä¢ AI Patient Education (Voice)</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #f4f7fb;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Container */
.container {
    width: 90%;
    max-width: 820px;
    height: 92vh;
    background: white;
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
.header {
    background: #2563eb;
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.header-left h1 {
    font-size: 18px;
    font-weight: 600;
}

.header-left p {
    font-size: 12px;
    opacity: 0.9;
}

.header-right button {
    background: transparent;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

/* Verification */
.verify-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 14px;
}

.input-group {
    width: 100%;
    max-width: 360px;
}

.input-group label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
}

.input-group input {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
}

.btn-primary {
    padding: 12px 28px;
    background: #2563eb;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

/* Voice Section */
.voice-section {
    display: none;
    flex-direction: column;
    flex: 1;
    min-height: 0;
}

.patient-info {
    padding: 10px 16px;
    background: #f1f5f9;
    font-size: 13px;
}

/* Conversation */
.conversation {
    flex: 1;
    padding: 20px;
    background: #f9fafb;
    overflow-y: auto;
}

.message {
    display: flex;
    margin-bottom: 14px;
}

.message.user { justify-content: flex-end; }
.message.assistant { justify-content: flex-start; }

.message-content {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.message.user .message-content {
    background: #2563eb;
    color: white;
    border-bottom-right-radius: 4px;
}

.message.assistant .message-content {
    background: #eef2f7;
    color: #1f2937;
    border-bottom-left-radius: 4px;
}

/* Voice Controls */
.voice-controls {
    padding: 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
}

.transcript-preview {
    width: 100%;
    max-width: 600px;
    min-height: 48px;
    padding: 12px;
    background: #f8fafc;
    border-radius: 10px;
    font-size: 14px;
    text-align: center;
    color: #374151;
}

.mic-button {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: #2563eb;
    color: white;
    font-size: 36px;
    border: none;
    cursor: pointer;
}

.mic-button.listening {
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.6); }
    70% { box-shadow: 0 0 0 18px rgba(37,99,235,0); }
    100% { box-shadow: 0 0 0 0 rgba(37,99,235,0); }
}

.status-text {
    font-size: 13px;
    color: #6b7280;
}

/* Upload (UI only) */
.upload-area { display: none; }
#fileInput { display: none; }

.upload-trigger {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #e0e7ff;
    border: none;
    font-size: 18px;
    color: #2563eb;
    cursor: pointer;

    display: flex;
    align-items: center;      /* vertical center */
    justify-content: center;
}

</style>
</head>

<body>

<div class="container">

    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <h1>Medilligence</h1>
            <p>AI Patient Education ‚Ä¢ Voice</p>
        </div>
        <div class="header-right">
            <button onclick="window.location.href='/static/chat.html'">üí¨</button>
        </div>
    </div>

    <!-- Verify -->
    <div class="verify-section" id="verifySection">
        <div class="input-group">
            <label for="mobileNumber">Enter your mobile number</label>
            <input type="tel" id="mobileNumber" placeholder="+91 1234567890">
        </div>
        <button class="btn-primary" onclick="verifyPatient()">Verify & Continue</button>
        <div id="verifyMessage"></div>
    </div>

    <!-- Voice -->
    <div class="voice-section" id="voiceSection">
        <div class="patient-info" id="patientInfo"></div>

        <div class="conversation" id="conversation"></div>

        <!-- Hidden upload logic (JS depends on these IDs) -->
        <div class="upload-area">
            <button id="uploadBtn"></button>
            <input type="file" id="fileInput" accept=".pdf">
            <div id="uploadStatus"></div>
        </div>

        <div class="voice-controls">
    <button class="upload-trigger"
            onclick="document.getElementById('fileInput').click()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
  <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0z"/>
</svg>
    </button>

    <div class="transcript-preview" id="transcriptPreview">
        Your words will appear here...
    </div>

    <button class="mic-button" id="micButton" onclick="toggleMic()">üé§</button>

    <div class="status-text" id="statusText">Listening...</div>
</div>
    </div>

</div>

<!-- üîí JS BELOW IS COPIED 1:1 FROM YOUR ORIGINAL FILE -->
<script>
    let patientId = null;
        let patientName = null;
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let isListening = false;
        let audioQueue = [];
        let isPlayingAudio = false;

        // Setup file input listener
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', uploadDocument);
            }
        });

        function switchMode(mode) {
            if (mode === 'chat') {
                window.location.href = '/static/chat.html';
            }
        }

        async function verifyPatient() {
            const mobile = document.getElementById('mobileNumber').value;
            const msgDiv = document.getElementById('verifyMessage');

            if (!mobile) {
                msgDiv.innerHTML = '<p class="error">Please enter mobile number</p>';
                return;
            }

            msgDiv.innerHTML = '<p class="loading">Verifying...</p>';

            try {
                const response = await fetch('/api/v1/verify-patient', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mobile_number: mobile })
                });

                const data = await response.json();

                if (data.verified) {
                    patientId = data.patient_id;
                    patientName = data.patient_name;
                    document.getElementById('verifySection').style.display = 'none';
                    document.getElementById('voiceSection').style.display = 'flex';
                    document.getElementById('patientInfo').innerHTML =
                        `<strong>Welcome, ${patientName}!</strong> Speak naturally - I'm listening.`;

                    await initializeVoice();
                } else {
                    msgDiv.innerHTML = `<p class="error">${data.message}</p>`;
                }
            } catch (error) {
                msgDiv.innerHTML = '<p class="error">Error verifying patient. Please try again.</p>';
                console.error('Verification error:', error);
            }
        }

        async function initializeVoice() {
            try {
                updateStatus('Requesting microphone access...');

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Initialize audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Setup WebSocket
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/api/v1/ws/voice/${patientId}`;

                ws = new WebSocket(wsUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected');
                    setupMediaRecorder(stream);
                };

                ws.onmessage = async (event) => {
                    if (event.data instanceof Blob) {
                        // Received audio
                        audioQueue.push(event.data);
                        if (!isPlayingAudio) {
                            playNextAudio();
                        }
                    } else {
                        const data = JSON.parse(event.data);
                        handleWebSocketMessage(data);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('Connection error');
                };

                ws.onclose = () => {
                    console.log('WebSocket closed');
                    updateStatus('Disconnected');
                    document.getElementById('micButton').disabled = true;
                };

            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('Failed to access microphone');
            }
        }

        function setupMediaRecorder(stream) {
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm'
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0 && ws.readyState === WebSocket.OPEN) {
                    ws.send(event.data);
                }
            };

            mediaRecorder.onstart = () => {
                console.log('Recording started');
            };

            mediaRecorder.onstop = () => {
                console.log('Recording stopped');
            };
        }

        function handleWebSocketMessage(data) {
            console.log('Message:', data);

            switch(data.type) {
                case 'status':
                    updateStatus(data.message);
                    if (data.message === 'Listening...') {
                        enableMic();
                    }
                    break;

                case 'interim_transcript':
                    document.getElementById('transcriptPreview').textContent = data.text;
                    break;

                case 'transcript':
                    document.getElementById('transcriptPreview').textContent = 'Processing...';
                    addMessage('user', data.text);
                    break;

                case 'response':
                    addMessage('assistant', data.text);
                    break;

                case 'audio_complete':
                    // Audio received completely
                    break;

                case 'speech_started':
                    console.log('User started speaking');
                    break;
            }
        }

        async function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlayingAudio = false;
                return;
            }

            isPlayingAudio = true;
            const audioBlob = audioQueue.shift();

            try {
                const arrayBuffer = await audioBlob.arrayBuffer();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

                const source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);

                source.onended = () => {
                    playNextAudio();
                };

                source.start(0);
            } catch (error) {
                console.error('Error playing audio:', error);
                playNextAudio();
            }
        }

        function toggleMic() {
            if (!isListening) {
                startListening();
            } else {
                stopListening();
            }
        }

        function startListening() {
            if (mediaRecorder && mediaRecorder.state === 'inactive') {
                mediaRecorder.start(100); // Send data every 100ms
                isListening = true;
                document.getElementById('micButton').classList.add('listening');
                document.getElementById('transcriptPreview').textContent = 'Listening...';
                updateStatus('Speak now...');
            }
        }

        function stopListening() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isListening = false;
                document.getElementById('micButton').classList.remove('listening');
                updateStatus('Processing...');
            }
        }

        function enableMic() {
            const micButton = document.getElementById('micButton');
            micButton.disabled = false;
            document.getElementById('transcriptPreview').textContent = 'Click microphone to speak...';
        }

        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        function addMessage(type, text) {
            const conversation = document.getElementById('conversation');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function uploadDocument(event) {
            const file = event.target.files[0];
            const statusDiv = document.getElementById('uploadStatus');
            const uploadBtn = document.getElementById('uploadBtn');

            if (!file) return;

            if (file.type !== 'application/pdf') {
                statusDiv.innerHTML = '<p class="error">Please upload a PDF file only</p>';
                event.target.value = '';
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                statusDiv.innerHTML = '<p class="error">File size must be less than 10MB</p>';
                event.target.value = '';
                return;
            }

            uploadBtn.disabled = true;
            addMessage('user', `üìÑ Uploaded: ${file.name}`);

            updateUploadStatus(statusDiv, '‚¨ÜÔ∏è Uploading document...', 'loading');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('patient_id', patientId);

            try {
                setTimeout(() => updateUploadStatus(statusDiv, 'üìÑ Extracting text from PDF...', 'loading'), 500);

                const response = await fetch('/api/v1/chat/upload-document', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json();
                    const errorMsg = data.detail || `Upload failed: ${response.status}`;
                    updateUploadStatus(statusDiv, `‚ùå ${errorMsg}`, 'error');
                    console.error('Backend error:', data);
                    setTimeout(() => statusDiv.innerHTML = '', 8000);
                    uploadBtn.disabled = false;
                    event.target.value = '';
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    updateUploadStatus(statusDiv, 'üîÑ Converting to standard format...', 'loading');
                    await sleep(800);

                    updateUploadStatus(statusDiv, 'ü§ñ Generating patient-friendly explanation...', 'loading');
                    await sleep(1000);

                    updateUploadStatus(statusDiv, '‚úì Document processed successfully!', 'success');
                    addMessage('assistant', data.explanation);

                    setTimeout(() => statusDiv.innerHTML = '', 5000);
                } else {
                    updateUploadStatus(statusDiv, `‚ùå ${data.message}`, 'error');
                    setTimeout(() => statusDiv.innerHTML = '', 5000);
                }
            } catch (error) {
                updateUploadStatus(statusDiv, '‚ùå Error uploading document. Please try again.', 'error');
                console.error('Upload error:', error);
                setTimeout(() => statusDiv.innerHTML = '', 5000);
            } finally {
                uploadBtn.disabled = false;
                event.target.value = '';
            }
        }

        function updateUploadStatus(statusDiv, message, type) {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';
            statusDiv.innerHTML = `<p class="${className}">${message}</p>`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        });
</script>

</body>
</html>
