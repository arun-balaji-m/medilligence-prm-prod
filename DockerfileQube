# ----------------------------
# Base image (lightweight)
# ----------------------------
FROM python:3.11

# ----------------------------
# Runtime environment
# ----------------------------
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
ENV PIP_NO_CACHE_DIR=1
ENV PIP_DISABLE_PIP_VERSION_CHECK=1
ENV MALLOC_ARENA_MAX=2
ENV PYTHONMALLOC=malloc

WORKDIR /app

# ----------------------------
# System dependencies (minimal)
# ----------------------------
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ----------------------------
# Python dependencies
# ----------------------------
COPY requirements-qube.txt .

RUN pip install --upgrade pip setuptools wheel && \
    pip install --no-cache-dir -r requirements-qube.txt

# ----------------------------
# Copy app source
# ----------------------------
COPY . .

# ----------------------------
# Render port
# ----------------------------
EXPOSE 10000

# ----------------------------
# Start API Gateway (QUBE)
# ----------------------------
CMD ["gunicorn", "main_qube:app", "-k", "uvicorn.workers.UvicornWorker", "--workers", "1", "--threads", "2", "--bind", "0.0.0.0:10000"]
