<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Voice Medical Appointment Assistant</title>-->
<!--    <style>-->
<!--        * {-->
<!--            margin: 0;-->
<!--            padding: 0;-->
<!--            box-sizing: border-box;-->
<!--        }-->

<!--        body {-->
<!--            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            height: 100vh;-->
<!--            display: flex;-->
<!--            justify-content: center;-->
<!--            align-items: center;-->
<!--            padding: 20px;-->
<!--        }-->

<!--        .voice-container {-->
<!--            width: 100%;-->
<!--            max-width: 800px;-->
<!--            background: white;-->
<!--            border-radius: 20px;-->
<!--            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);-->
<!--            padding: 40px;-->
<!--            text-align: center;-->
<!--        }-->

<!--        .header {-->
<!--            margin-bottom: 30px;-->
<!--        }-->

<!--        .header h1 {-->
<!--            font-size: 32px;-->
<!--            color: #667eea;-->
<!--            margin-bottom: 10px;-->
<!--        }-->

<!--        .header p {-->
<!--            color: #666;-->
<!--            font-size: 16px;-->
<!--        }-->

<!--        .mode-toggle {-->
<!--            display: flex;-->
<!--            justify-content: center;-->
<!--            gap: 10px;-->
<!--            margin-bottom: 30px;-->
<!--        }-->

<!--        .mode-btn {-->
<!--            padding: 10px 20px;-->
<!--            border: 2px solid #667eea;-->
<!--            background: white;-->
<!--            color: #667eea;-->
<!--            border-radius: 25px;-->
<!--            cursor: pointer;-->
<!--            font-size: 14px;-->
<!--            font-weight: 600;-->
<!--            transition: all 0.3s;-->
<!--        }-->

<!--        .mode-btn.active {-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            color: white;-->
<!--        }-->

<!--        .mode-btn:hover {-->
<!--            transform: translateY(-2px);-->
<!--            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);-->
<!--        }-->

<!--        .microphone-wrapper {-->
<!--            margin: 40px 0;-->
<!--        }-->

<!--        .microphone-button {-->
<!--            width: 120px;-->
<!--            height: 120px;-->
<!--            border-radius: 50%;-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            border: none;-->
<!--            cursor: pointer;-->
<!--            display: inline-flex;-->
<!--            align-items: center;-->
<!--            justify-content: center;-->
<!--            transition: all 0.3s;-->
<!--            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);-->
<!--        }-->

<!--        .microphone-button:hover {-->
<!--            transform: scale(1.1);-->
<!--            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);-->
<!--        }-->

<!--        .microphone-button.listening {-->
<!--            animation: pulse 1.5s infinite;-->
<!--            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);-->
<!--        }-->

<!--        .microphone-button.processing {-->
<!--            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);-->
<!--        }-->

<!--        @keyframes pulse {-->
<!--            0%, 100% {-->
<!--                transform: scale(1);-->
<!--                box-shadow: 0 10px 30px rgba(240, 147, 251, 0.4);-->
<!--            }-->
<!--            50% {-->
<!--                transform: scale(1.1);-->
<!--                box-shadow: 0 15px 40px rgba(240, 147, 251, 0.6);-->
<!--            }-->
<!--        }-->

<!--        .microphone-icon {-->
<!--            font-size: 48px;-->
<!--            color: white;-->
<!--        }-->

<!--        .status {-->
<!--            font-size: 18px;-->
<!--            color: #667eea;-->
<!--            margin: 20px 0;-->
<!--            min-height: 30px;-->
<!--            font-weight: 600;-->
<!--        }-->

<!--        .transcript-section {-->
<!--            margin: 30px 0;-->
<!--            text-align: left;-->
<!--        }-->

<!--        .transcript-box {-->
<!--            background: #f7f7f7;-->
<!--            border-radius: 15px;-->
<!--            padding: 20px;-->
<!--            min-height: 150px;-->
<!--            max-height: 300px;-->
<!--            overflow-y: auto;-->
<!--        }-->

<!--        .transcript-label {-->
<!--            font-weight: 600;-->
<!--            color: #667eea;-->
<!--            margin-bottom: 10px;-->
<!--            display: block;-->
<!--        }-->

<!--        .transcript-text {-->
<!--            color: #333;-->
<!--            line-height: 1.6;-->
<!--            margin-bottom: 15px;-->
<!--        }-->

<!--        .transcript-text.user {-->
<!--            color: #764ba2;-->
<!--            font-weight: 500;-->
<!--        }-->

<!--        .transcript-text.assistant {-->
<!--            color: #667eea;-->
<!--        }-->

<!--        .controls {-->
<!--            display: flex;-->
<!--            justify-content: center;-->
<!--            gap: 15px;-->
<!--            margin-top: 30px;-->
<!--        }-->

<!--        .control-btn {-->
<!--            padding: 12px 24px;-->
<!--            border: none;-->
<!--            border-radius: 25px;-->
<!--            cursor: pointer;-->
<!--            font-size: 14px;-->
<!--            font-weight: 600;-->
<!--            transition: all 0.3s;-->
<!--        }-->

<!--        .control-btn.primary {-->
<!--            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);-->
<!--            color: white;-->
<!--        }-->

<!--        .control-btn.secondary {-->
<!--            background: #f44336;-->
<!--            color: white;-->
<!--        }-->

<!--        .control-btn:hover {-->
<!--            transform: translateY(-2px);-->
<!--            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);-->
<!--        }-->

<!--        .control-btn:disabled {-->
<!--            opacity: 0.5;-->
<!--            cursor: not-allowed;-->
<!--            transform: none;-->
<!--        }-->

<!--        .error-message {-->
<!--            background: #ffebee;-->
<!--            color: #c62828;-->
<!--            padding: 15px;-->
<!--            border-radius: 10px;-->
<!--            margin-top: 20px;-->
<!--            display: none;-->
<!--        }-->

<!--        .error-message.show {-->
<!--            display: block;-->
<!--        }-->

<!--        .back-link {-->
<!--            margin-top: 20px;-->
<!--        }-->

<!--        .back-link a {-->
<!--            color: #667eea;-->
<!--            text-decoration: none;-->
<!--            font-weight: 600;-->
<!--        }-->

<!--        .back-link a:hover {-->
<!--            text-decoration: underline;-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--    <div class="voice-container">-->
<!--        <div class="header">-->
<!--            <h1>üé§ Voice Medical Assistant</h1>-->
<!--            <p>Talk to book, cancel, or manage your appointments</p>-->
<!--        </div>-->

<!--        <div class="mode-toggle">-->
<!--            <a href="/" style="text-decoration: none;">-->
<!--                <button class="mode-btn">üí¨ Text Chat</button>-->
<!--            </a>-->
<!--            <button class="mode-btn active">üé§ Voice Chat</button>-->
<!--        </div>-->

<!--        <div class="microphone-wrapper">-->
<!--            <button class="microphone-button" id="micButton">-->
<!--                <span class="microphone-icon">üé§</span>-->
<!--            </button>-->
<!--        </div>-->

<!--        <div class="status" id="status">Click microphone to start</div>-->

<!--        <div class="transcript-section">-->
<!--            <div class="transcript-box" id="transcriptBox">-->
<!--                <span class="transcript-label">Conversation:</span>-->
<!--                <div id="conversation"></div>-->
<!--            </div>-->
<!--        </div>-->

<!--        <div class="controls">-->
<!--            <button class="control-btn secondary" id="clearBtn">Clear Conversation</button>-->
<!--        </div>-->

<!--        <div class="error-message" id="errorMessage"></div>-->

<!--        <div class="back-link">-->
<!--            <a href="/">‚Üê Switch to Text Chat</a>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--        let websocket = null;-->
<!--        let mediaRecorder = null;-->
<!--        let audioContext = null;-->
<!--        let isListening = false;-->
<!--        let audioQueue = [];-->
<!--        let isPlayingAudio = false;-->

<!--        const micButton = document.getElementById('micButton');-->
<!--        const status = document.getElementById('status');-->
<!--        const conversation = document.getElementById('conversation');-->
<!--        const errorMessage = document.getElementById('errorMessage');-->
<!--        const clearBtn = document.getElementById('clearBtn');-->

<!--        function showError(message) {-->
<!--            errorMessage.textContent = message;-->
<!--            errorMessage.classList.add('show');-->
<!--            setTimeout(() => {-->
<!--                errorMessage.classList.remove('show');-->
<!--            }, 5000);-->
<!--        }-->

<!--        function updateStatus(message, className = '') {-->
<!--            status.textContent = message;-->
<!--            micButton.className = 'microphone-button ' + className;-->
<!--        }-->

<!--        function addToConversation(text, isUser) {-->
<!--            const div = document.createElement('div');-->
<!--            div.className = `transcript-text ${isUser ? 'user' : 'assistant'}`;-->
<!--            div.textContent = `${isUser ? 'You' : 'Assistant'}: ${text}`;-->
<!--            conversation.appendChild(div);-->
<!--            document.getElementById('transcriptBox').scrollTop = document.getElementById('transcriptBox').scrollHeight;-->
<!--        }-->

<!--        async function playAudio(audioData) {-->
<!--            return new Promise((resolve) => {-->
<!--                const audioBlob = new Blob([audioData], { type: 'audio/mpeg' });-->
<!--                const audioUrl = URL.createObjectURL(audioBlob);-->
<!--                const audio = new Audio(audioUrl);-->

<!--                audio.onended = () => {-->
<!--                    URL.revokeObjectURL(audioUrl);-->
<!--                    resolve();-->
<!--                };-->

<!--                audio.onerror = (error) => {-->
<!--                    console.error('Audio playback error:', error);-->
<!--                    resolve();-->
<!--                };-->

<!--                audio.play().catch(error => {-->
<!--                    console.error('Play error:', error);-->
<!--                    resolve();-->
<!--                });-->
<!--            });-->
<!--        }-->

<!--        async function processAudioQueue() {-->
<!--            if (isPlayingAudio || audioQueue.length === 0) return;-->

<!--            isPlayingAudio = true;-->
<!--            const audioData = audioQueue.shift();-->
<!--            await playAudio(audioData);-->
<!--            isPlayingAudio = false;-->

<!--            if (audioQueue.length > 0) {-->
<!--                processAudioQueue();-->
<!--            }-->
<!--        }-->

<!--        async function connectWebSocket() {-->
<!--            return new Promise((resolve, reject) => {-->
<!--                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';-->
<!--                const wsUrl = `${protocol}//${window.location.host}/api/voice/ws`;-->

<!--                console.log('Connecting to:', wsUrl);-->
<!--                websocket = new WebSocket(wsUrl);-->

<!--                websocket.onopen = () => {-->
<!--                    console.log('WebSocket connected');-->
<!--                    updateStatus('Connected - Ready to listen', '');-->
<!--                    resolve();-->
<!--                };-->

<!--                websocket.onmessage = async (event) => {-->
<!--                    if (event.data instanceof Blob) {-->
<!--                        // Audio data received-->
<!--                        console.log('Received audio blob:', event.data.size, 'bytes');-->
<!--                        const arrayBuffer = await event.data.arrayBuffer();-->
<!--                        audioQueue.push(arrayBuffer);-->
<!--                        processAudioQueue();-->
<!--                    } else {-->
<!--                        // JSON message-->
<!--                        const data = JSON.parse(event.data);-->
<!--                        console.log('Received:', data);-->

<!--                        if (data.type === 'status') {-->
<!--                            updateStatus(data.message, data.message.includes('Speaking') ? 'processing' : 'listening');-->
<!--                        } else if (data.type === 'transcript') {-->
<!--                            addToConversation(data.text, true);-->
<!--                        } else if (data.type === 'response') {-->
<!--                            addToConversation(data.text, false);-->
<!--                        } else if (data.type === 'interim_transcript') {-->
<!--                            updateStatus(`Hearing: "${data.text}"`, 'listening');-->
<!--                        } else if (data.type === 'audio_complete') {-->
<!--                            console.log('Audio playback complete');-->
<!--                        } else if (data.type === 'error') {-->
<!--                            showError(data.message);-->
<!--                        }-->
<!--                    }-->
<!--                };-->

<!--                websocket.onerror = (error) => {-->
<!--                    console.error('WebSocket error:', error);-->
<!--                    showError('Connection error occurred');-->
<!--                    reject(error);-->
<!--                };-->

<!--                websocket.onclose = () => {-->
<!--                    console.log('WebSocket closed');-->
<!--                    updateStatus('Disconnected - Click mic to reconnect', '');-->
<!--                    isListening = false;-->
<!--                    websocket = null;-->
<!--                };-->

<!--                // Timeout after 5 seconds-->
<!--                setTimeout(() => {-->
<!--                    if (websocket && websocket.readyState !== WebSocket.OPEN) {-->
<!--                        reject(new Error('Connection timeout'));-->
<!--                    }-->
<!--                }, 5000);-->
<!--            });-->
<!--        }-->

<!--        async function startListening() {-->
<!--            try {-->
<!--                const stream = await navigator.mediaDevices.getUserMedia({-->
<!--                    audio: {-->
<!--                        channelCount: 1,-->
<!--                        sampleRate: 16000,-->
<!--                        echoCancellation: true,-->
<!--                        noiseSuppression: true,-->
<!--                        autoGainControl: true-->
<!--                    }-->
<!--                });-->

<!--                console.log('Microphone access granted');-->

<!--                audioContext = new (window.AudioContext || window.webkitAudioContext)({-->
<!--                    sampleRate: 16000-->
<!--                });-->

<!--                await audioContext.resume();-->

<!--                const source = audioContext.createMediaStreamSource(stream);-->
<!--                const processor = audioContext.createScriptProcessor(4096, 1, 1);-->

<!--                source.connect(processor);-->
<!--                processor.connect(audioContext.destination);-->

<!--                processor.onaudioprocess = (e) => {-->
<!--                    if (websocket && websocket.readyState === WebSocket.OPEN && isListening) {-->
<!--                        const inputData = e.inputBuffer.getChannelData(0);-->

<!--                        // Convert to 16-bit PCM-->
<!--                        const pcm16 = new Int16Array(inputData.length);-->
<!--                        for (let i = 0; i < inputData.length; i++) {-->
<!--                            const s = Math.max(-1, Math.min(1, inputData[i]));-->
<!--                            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;-->
<!--                        }-->

<!--                        // Send as bytes-->
<!--                        websocket.send(pcm16.buffer);-->
<!--                    }-->
<!--                };-->

<!--                mediaRecorder = { stream, processor, source };-->
<!--                isListening = true;-->
<!--                updateStatus('Listening... Speak now', 'listening');-->
<!--                console.log('Started listening');-->

<!--            } catch (error) {-->
<!--                console.error('Error starting microphone:', error);-->
<!--                showError('Could not access microphone: ' + error.message);-->
<!--            }-->
<!--        }-->

<!--        function stopListening() {-->
<!--            if (mediaRecorder) {-->
<!--                console.log('Stopping microphone');-->
<!--                mediaRecorder.stream.getTracks().forEach(track => track.stop());-->
<!--                mediaRecorder.processor.disconnect();-->
<!--                mediaRecorder.source.disconnect();-->
<!--                if (audioContext) {-->
<!--                    audioContext.close();-->
<!--                    audioContext = null;-->
<!--                }-->
<!--                mediaRecorder = null;-->
<!--            }-->
<!--            isListening = false;-->
<!--            updateStatus('Stopped - Click to start again', '');-->
<!--        }-->

<!--        micButton.addEventListener('click', async () => {-->
<!--            try {-->
<!--                if (!websocket || websocket.readyState !== WebSocket.OPEN) {-->
<!--                    updateStatus('Connecting...', 'processing');-->
<!--                    await connectWebSocket();-->
<!--                    // Wait a moment for welcome message-->
<!--                    await new Promise(resolve => setTimeout(resolve, 1500));-->
<!--                    await startListening();-->
<!--                } else if (isListening) {-->
<!--                    stopListening();-->
<!--                } else {-->
<!--                    await startListening();-->
<!--                }-->
<!--            } catch (error) {-->
<!--                console.error('Error:', error);-->
<!--                showError('Failed to connect or start microphone: ' + error.message);-->
<!--                updateStatus('Error - Click to retry', '');-->
<!--            }-->
<!--        });-->

<!--        clearBtn.addEventListener('click', () => {-->
<!--            conversation.innerHTML = '<span class="transcript-label">Conversation:</span>';-->
<!--            if (websocket && websocket.readyState === WebSocket.OPEN) {-->
<!--                websocket.close();-->
<!--            }-->
<!--            websocket = null;-->
<!--            stopListening();-->
<!--            audioQueue = [];-->
<!--            isPlayingAudio = false;-->
<!--            updateStatus('Click microphone to start', '');-->
<!--        });-->

<!--        // Cleanup on page unload-->
<!--        window.addEventListener('beforeunload', () => {-->
<!--            if (websocket) {-->
<!--                websocket.close();-->
<!--            }-->
<!--            stopListening();-->
<!--        });-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->

<!--new voice ui generated by chatgpt-->

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Medilligence ‚Ä¢ Voice Assistant</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #f4f7fb;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* Container */
.voice-container {
    width: 100%;
    max-width: 820px;
    height: 92vh;
    background: #ffffff;
    border-radius: 18px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* Header */
.voice-header {
    background: #2563eb;
    color: white;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.voice-header .back {
    cursor: pointer;
    font-size: 18px;
}

.voice-header h1 {
    font-size: 18px;
    font-weight: 600;
}

.voice-header p {
    font-size: 12px;
    opacity: 0.9;
}

/* Chat */
.voice-messages {
    flex: 1;
    padding: 20px;
    background: #f9fafb;
    overflow-y: auto;
}

.message {
    display: flex;
    margin-bottom: 14px;
}

.message.user { justify-content: flex-end; }
.message.assistant { justify-content: flex-start; }

.bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.message.user .bubble {
    background: #2563eb;
    color: white;
    border-bottom-right-radius: 4px;
}

.message.assistant .bubble {
    background: #eef2f7;
    color: #1f2937;
    border-bottom-left-radius: 4px;
}

/* Voice Bar */
.voice-bar {
    border-top: 1px solid #e5e7eb;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    gap: 14px;
    background: #ffffff;
}

.chat-icon {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    border: none;
    background: #e0e7ff;
    color: #2563eb;
    font-size: 18px;
    cursor: pointer;

    display: flex;
    align-items: center;      /* vertical center */
    justify-content: center;
}

.mic-area {
    flex: 1;
    background: #f3f4f6;
    border-radius: 28px;
    padding: 10px 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    cursor: pointer;
}

.mic {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #2563eb;
    color: white;
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mic.listening {
    animation: pulse 1.4s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(37,99,235,0.6); }
    70% { box-shadow: 0 0 0 14px rgba(37,99,235,0); }
    100% { box-shadow: 0 0 0 0 rgba(37,99,235,0); }
}

.status {
    font-size: 13px;
    color: #374151;
}

/* Clear */
.clear-btn {
    font-size: 12px;
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 10px;
}
</style>
</head>

<body>

<div class="voice-container">

    <!-- Header -->
    <div class="voice-header">
        <div class="back" onclick="goToText()">üí¨</div>
        <div>
            <h1>Medilligence</h1>
            <p>Voice Assistant ‚Ä¢ Manage appointments</p>
        </div>
    </div>

    <!-- Messages -->
    <div class="voice-messages" id="chat">
        <div class="message assistant">
            <div class="bubble">
                Hello! I‚Äôm your medical appointment assistant. How can I help you today?
            </div>
        </div>
    </div>

    <!-- Voice Bar -->
    <div class="voice-bar">
        <button class="chat-icon" onclick="goToText()">üí¨</button>

        <div class="mic-area" id="micButton">
            <div class="mic" id="micIcon">üé§</div>
            <div class="status" id="status">Tap to speak</div>
        </div>

        <button class="clear-btn" id="clearBtn">Clear</button>
    </div>

</div>

<script>
/* ========= Navigation ========= */
function goToText() {
    window.location.href = "/";
}

/* ========= Chat Helpers ========= */
const chat = document.getElementById("chat");
const statusEl = document.getElementById("status");
const micIcon = document.getElementById("micIcon");
const micButton = document.getElementById("micButton");
const clearBtn = document.getElementById("clearBtn");

let websocket = null;
let isListening = false;

function addMessage(text, isUser) {
    const msg = document.createElement("div");
    msg.className = "message " + (isUser ? "user" : "assistant");

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    msg.appendChild(bubble);
    chat.appendChild(msg);
    chat.scrollTop = chat.scrollHeight;
}

function updateStatus(text, listening=false) {
    statusEl.textContent = text;
    micIcon.classList.toggle("listening", listening);
}

/* ========= Mic Click ========= */
micButton.addEventListener("click", async () => {
    if (!websocket) {
        updateStatus("Connecting...");
        connectWebSocket();
        return;
    }

    if (isListening) {
        stopListening();
    } else {
        startListening();
    }
});

/* ========= WebSocket (kept same logic) ========= */
function connectWebSocket() {
    const protocol = location.protocol === "https:" ? "wss:" : "ws:";
    websocket = new WebSocket(`${protocol}//${location.host}/api/voice/ws`);

    websocket.onopen = () => {
        updateStatus("Listening‚Ä¶", true);
        startListening();
    };

    websocket.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.type === "transcript") addMessage(data.text, true);
        if (data.type === "response") addMessage(data.text, false);
    };

    websocket.onclose = () => {
        websocket = null;
        updateStatus("Tap to speak");
    };
}

function startListening() {
    isListening = true;
    updateStatus("Listening‚Ä¶", true);
}

function stopListening() {
    isListening = false;
    updateStatus("Tap to speak");
}

clearBtn.onclick = () => {
    chat.innerHTML = "";
    updateStatus("Tap to speak");
};
</script>

</body>
</html>
