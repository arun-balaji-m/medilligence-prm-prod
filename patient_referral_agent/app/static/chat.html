<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Medilligence • Patient Referral</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #f4f7fb;
}

/* Layout */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 20px;
    height: 100vh;
}

/* Chat Section */
.chat-section {
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    overflow: hidden;
}

/* Header */
.chat-header {
    padding: 18px 24px;
    background: #2563eb;
    color: white;
}
.chat-header h1 {
    font-size: 20px;
    font-weight: 600;
}
.chat-header p {
    font-size: 13px;
    opacity: 0.9;
}

/* Messages */
.messages {
    flex: 1;
    padding: 22px;
    background: #f9fafb;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.message {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.message.bot {
    background: #eef2f7;
    color: #1f2937;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.message.user {
    background: #2563eb;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

/* Input Bar */
.input-area {
    padding: 14px 18px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 10px;
    background: white;
}

.input-area input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 22px;
    border: 1px solid #d1d5db;
    font-size: 14px;
}

.icon-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #e0e7ff;
    border: none;
    font-size: 18px;
    color: #2563eb;
    cursor: pointer;

    display: flex;
    align-items: center;
    justify-content: center;
}

.send-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #2563eb;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;

    display: flex;
    align-items: center;
    justify-content: center;
}

/* Upload area (logic preserved, UI hidden) */
.file-upload {
    display: none;
}

/* Timeline Section — UNCHANGED */
.timeline-section {
    background: white;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.timeline-header {
    padding: 18px 20px;
    background: #2563eb;
    color: white;
}

.timeline-header h2 {
    font-size: 18px;
}

.timeline-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Responsive */
@media (max-width: 1024px) {
    .container {
        grid-template-columns: 1fr;
        height: auto;
    }
    .timeline-section {
        height: 500px;
    }
}
</style>
</head>

<body>

<div class="container">

    <!-- Chat Section -->
    <div class="chat-section">

        <div class="chat-header">
            <h1>Medilligence</h1>
            <p>Patient Referral & Care Coordination</p>
        </div>

        <div class="messages" id="messages">
            <div class="message bot">
                Hello! I'm here to help you with your referral. Let's start by collecting some basic information. What is your full name?
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Type your message..." />
            <button class="icon-btn" onclick="document.getElementById('fileInput').click()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
  <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0z"/>
</svg>
            </button>
            <button class="send-btn" id="sendBtn">➤</button>
        </div>


        <div class="file-upload" id="fileUploadSection">
            <input type="file" id="fileInput" accept=".pdf" />
            <button id="uploadBtn">Upload</button>
        </div>

    </div>


    <div class="timeline-section">
        <div class="timeline-header">
            <h2>Medical Timeline</h2>
        </div>

        <div class="timeline-container" id="timeline">
            <div class="empty-timeline">
                Timeline will appear here once information is collected
            </div>
        </div>
    </div>

</div>

<script>
    const sessionId = 'session_' + Date.now();
        let patientId = null;

        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const fileUploadSection = document.getElementById('fileUploadSection');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const timeline = document.getElementById('timeline');

        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'bot'}`;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function addLoading() {
            const div = document.createElement('div');
            div.className = 'loading';
            div.innerHTML = '<span></span><span></span><span></span>';
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
            return div;
        }

        function updateTimeline(events) {
            if (!events || events.length === 0) return;

            timeline.innerHTML = '';
            events.forEach(event => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="timeline-date">${event.date}</div>
                    <div class="timeline-title">${event.title}</div>
                    <div class="timeline-summary">${event.summary}</div>
                    <span class="timeline-category">${event.category}</span>
                    <div class="timeline-details">${event.details}</div>
                `;

                item.addEventListener('click', () => {
                    item.classList.toggle('expanded');
                });

                timeline.appendChild(item);
            });
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            sendBtn.disabled = true;

            const loading = addLoading();

            try {
                const formData = new FormData();
                formData.append('message', message);
                formData.append('session_id', sessionId);
                if (patientId) {
                    formData.append('patient_id', patientId.toString());
                }

                console.log('Sending message:', message, 'Session:', sessionId, 'Patient:', patientId);

                const response = await fetch('api/referral/chat', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response:', data);

                loading.remove();

                addMessage(data.response);

                if (data.patient_id) {
                    patientId = data.patient_id;
                    console.log('Patient ID set:', patientId);
                }

                if (data.input_type === 'text_or_file') {
                    fileUploadSection.style.display = 'flex';
                }

                if (data.timeline) {
                    updateTimeline(data.timeline);
                }

            } catch (error) {
                loading.remove();
                addMessage('Sorry, there was an error. Please try again.');
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
            }
        }

        async function uploadDocument() {
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!patientId) {
                alert('Please complete registration first');
                return;
            }

            addMessage('Uploading document...', true);
            uploadBtn.disabled = true;

            const loading = addLoading();

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('patient_id', patientId);
                formData.append('session_id', sessionId);

                const response = await fetch('api/referral/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                loading.remove();

                addMessage(data.response);

                if (data.timeline) {
                    updateTimeline(data.timeline);
                }

                fileInput.value = '';

            } catch (error) {
                loading.remove();
                addMessage('Error uploading document. Please try again.');
                console.error(error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        uploadBtn.addEventListener('click', uploadDocument);
</script>

</body>
</html>
