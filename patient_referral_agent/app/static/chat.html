<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>AI Referral & Coordination</title>-->
<!--    <style>-->
<!--        * { margin: 0; padding: 0; box-sizing: border-box; }-->
<!--        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }-->
<!--        .container { max-width: 1400px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 400px; gap: 20px; height: 100vh; }-->

<!--        /* Chat Section */-->
<!--        .chat-section { display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }-->
<!--        .chat-header { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }-->
<!--        .chat-header h1 { font-size: 24px; margin-bottom: 5px; }-->
<!--        .chat-header p { font-size: 14px; opacity: 0.9; }-->

<!--        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }-->
<!--        .message { max-width: 80%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; }-->
<!--        .message.bot { background: #f0f0f0; align-self: flex-start; }-->
<!--        .message.user { background: #667eea; color: white; align-self: flex-end; }-->

<!--        .input-area { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }-->
<!--        .input-area input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }-->
<!--        .input-area button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s; }-->
<!--        .input-area button:hover { background: #5568d3; }-->
<!--        .input-area button:disabled { background: #ccc; cursor: not-allowed; }-->

<!--        .file-upload { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #eee; }-->
<!--        .file-upload input[type="file"] { flex: 1; }-->
<!--        .file-upload button { padding: 12px 24px; background: #764ba2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }-->

<!--        /* Timeline Section */-->
<!--        .timeline-section { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }-->
<!--        .timeline-header { padding: 20px; background: #764ba2; color: white; }-->
<!--        .timeline-header h2 { font-size: 20px; }-->

<!--        .timeline-container { flex: 1; overflow-y: auto; padding: 20px; }-->
<!--        .timeline-item { position: relative; padding-left: 30px; padding-bottom: 30px; border-left: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }-->
<!--        .timeline-item:hover { background: #f9f9f9; margin-left: -10px; padding-left: 40px; }-->
<!--        .timeline-item:last-child { border-left: none; }-->

<!--        .timeline-dot { position: absolute; left: -6px; top: 0; width: 12px; height: 12px; background: #667eea; border-radius: 50%; }-->
<!--        .timeline-date { font-size: 12px; color: #999; margin-bottom: 5px; }-->
<!--        .timeline-title { font-weight: 600; color: #333; margin-bottom: 5px; }-->
<!--        .timeline-summary { font-size: 14px; color: #666; }-->
<!--        .timeline-category { display: inline-block; margin-top: 5px; padding: 3px 8px; background: #e8eaf6; color: #667eea; border-radius: 4px; font-size: 12px; }-->

<!--        .timeline-details { display: none; margin-top: 10px; padding: 15px; background: #f5f7fa; border-radius: 8px; font-size: 14px; color: #555; line-height: 1.6; }-->
<!--        .timeline-item.expanded .timeline-details { display: block; }-->

<!--        .empty-timeline { text-align: center; padding: 40px; color: #999; }-->

<!--        .loading { display: flex; gap: 5px; padding: 20px; }-->
<!--        .loading span { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }-->
<!--        .loading span:nth-child(1) { animation-delay: -0.32s; }-->
<!--        .loading span:nth-child(2) { animation-delay: -0.16s; }-->

<!--        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }-->

<!--        @media (max-width: 1024px) {-->
<!--            .container { grid-template-columns: 1fr; height: auto; }-->
<!--            .timeline-section { height: 500px; }-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--    <div class="container">-->
<!--        &lt;!&ndash; Chat Section &ndash;&gt;-->
<!--        <div class="chat-section">-->
<!--            <div class="chat-header">-->
<!--                <h1>AI Referral & Coordination</h1>-->
<!--                <p>Let's collect your information and medical history</p>-->
<!--            </div>-->

<!--            <div class="messages" id="messages">-->
<!--                <div class="message bot">-->
<!--                    Hello! I'm here to help you with your referral. Let's start by collecting some basic information. What is your full name?-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="input-area">-->
<!--                <input type="text" id="messageInput" placeholder="Type your message..." />-->
<!--                <button id="sendBtn">Send</button>-->
<!--            </div>-->

<!--            <div class="file-upload" id="fileUploadSection" style="display: none;">-->
<!--                <input type="file" id="fileInput" accept=".pdf" />-->
<!--                <button id="uploadBtn">Upload Document</button>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Timeline Section &ndash;&gt;-->
<!--        <div class="timeline-section">-->
<!--            <div class="timeline-header">-->
<!--                <h2>Medical Timeline</h2>-->
<!--            </div>-->

<!--            <div class="timeline-container" id="timeline">-->
<!--                <div class="empty-timeline">Timeline will appear here once information is collected</div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--        const sessionId = 'session_' + Date.now();-->
<!--        let patientId = null;-->

<!--        const messages = document.getElementById('messages');-->
<!--        const messageInput = document.getElementById('messageInput');-->
<!--        const sendBtn = document.getElementById('sendBtn');-->
<!--        const fileUploadSection = document.getElementById('fileUploadSection');-->
<!--        const fileInput = document.getElementById('fileInput');-->
<!--        const uploadBtn = document.getElementById('uploadBtn');-->
<!--        const timeline = document.getElementById('timeline');-->

<!--        function addMessage(text, isUser = false) {-->
<!--            const div = document.createElement('div');-->
<!--            div.className = `message ${isUser ? 'user' : 'bot'}`;-->
<!--            div.textContent = text;-->
<!--            messages.appendChild(div);-->
<!--            messages.scrollTop = messages.scrollHeight;-->
<!--        }-->

<!--        function addLoading() {-->
<!--            const div = document.createElement('div');-->
<!--            div.className = 'loading';-->
<!--            div.innerHTML = '<span></span><span></span><span></span>';-->
<!--            messages.appendChild(div);-->
<!--            messages.scrollTop = messages.scrollHeight;-->
<!--            return div;-->
<!--        }-->

<!--        function updateTimeline(events) {-->
<!--            if (!events || events.length === 0) return;-->

<!--            timeline.innerHTML = '';-->
<!--            events.forEach(event => {-->
<!--                const item = document.createElement('div');-->
<!--                item.className = 'timeline-item';-->
<!--                item.innerHTML = `-->
<!--                    <div class="timeline-dot"></div>-->
<!--                    <div class="timeline-date">${event.date}</div>-->
<!--                    <div class="timeline-title">${event.title}</div>-->
<!--                    <div class="timeline-summary">${event.summary}</div>-->
<!--                    <span class="timeline-category">${event.category}</span>-->
<!--                    <div class="timeline-details">${event.details}</div>-->
<!--                `;-->

<!--                item.addEventListener('click', () => {-->
<!--                    item.classList.toggle('expanded');-->
<!--                });-->

<!--                timeline.appendChild(item);-->
<!--            });-->
<!--        }-->

<!--        async function sendMessage() {-->
<!--            const message = messageInput.value.trim();-->
<!--            if (!message) return;-->

<!--            addMessage(message, true);-->
<!--            messageInput.value = '';-->
<!--            sendBtn.disabled = true;-->

<!--            const loading = addLoading();-->

<!--            try {-->
<!--                const formData = new FormData();-->
<!--                formData.append('message', message);-->
<!--                formData.append('session_id', sessionId);-->
<!--                if (patientId) formData.append('patient_id', patientId);-->

<!--                const response = await fetch('/api/referral/chat', {-->
<!--                    method: 'POST',-->
<!--                    body: formData-->
<!--                });-->

<!--                const data = await response.json();-->
<!--                loading.remove();-->

<!--                addMessage(data.response);-->

<!--                if (data.patient_id) {-->
<!--                    patientId = data.patient_id;-->
<!--                }-->

<!--                if (data.input_type === 'text_or_file') {-->
<!--                    fileUploadSection.style.display = 'flex';-->
<!--                }-->

<!--                if (data.timeline) {-->
<!--                    updateTimeline(data.timeline);-->
<!--                }-->

<!--            } catch (error) {-->
<!--                loading.remove();-->
<!--                addMessage('Sorry, there was an error. Please try again.');-->
<!--                console.error(error);-->
<!--            } finally {-->
<!--                sendBtn.disabled = false;-->
<!--            }-->
<!--        }-->

<!--        async function uploadDocument() {-->
<!--            const file = fileInput.files[0];-->
<!--            if (!file) {-->
<!--                alert('Please select a file');-->
<!--                return;-->
<!--            }-->

<!--            if (!patientId) {-->
<!--                alert('Please complete registration first');-->
<!--                return;-->
<!--            }-->

<!--            addMessage('Uploading document...', true);-->
<!--            uploadBtn.disabled = true;-->

<!--            const loading = addLoading();-->

<!--            try {-->
<!--                const formData = new FormData();-->
<!--                formData.append('file', file);-->
<!--                formData.append('patient_id', patientId);-->
<!--                formData.append('session_id', sessionId);-->

<!--                const response = await fetch('/api/referral/upload', {-->
<!--                    method: 'POST',-->
<!--                    body: formData-->
<!--                });-->

<!--                const data = await response.json();-->
<!--                loading.remove();-->

<!--                addMessage(data.response);-->

<!--                if (data.timeline) {-->
<!--                    updateTimeline(data.timeline);-->
<!--                }-->

<!--                fileInput.value = '';-->

<!--            } catch (error) {-->
<!--                loading.remove();-->
<!--                addMessage('Error uploading document. Please try again.');-->
<!--                console.error(error);-->
<!--            } finally {-->
<!--                uploadBtn.disabled = false;-->
<!--            }-->
<!--        }-->

<!--        sendBtn.addEventListener('click', sendMessage);-->
<!--        messageInput.addEventListener('keypress', (e) => {-->
<!--            if (e.key === 'Enter') sendMessage();-->
<!--        });-->
<!--        uploadBtn.addEventListener('click', uploadDocument);-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->

<!--Second version -->

<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>AI Referral & Coordination</title>-->
<!--    <style>-->
<!--        * { margin: 0; padding: 0; box-sizing: border-box; }-->
<!--        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; }-->
<!--        .container { max-width: 1400px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1fr 400px; gap: 20px; height: 100vh; }-->

<!--        /* Chat Section */-->
<!--        .chat-section { display: flex; flex-direction: column; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }-->
<!--        .chat-header { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }-->
<!--        .chat-header h1 { font-size: 24px; margin-bottom: 5px; }-->
<!--        .chat-header p { font-size: 14px; opacity: 0.9; }-->

<!--        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }-->
<!--        .message { max-width: 80%; padding: 12px 16px; border-radius: 12px; line-height: 1.5; }-->
<!--        .message.bot { background: #f0f0f0; align-self: flex-start; }-->
<!--        .message.user { background: #667eea; color: white; align-self: flex-end; }-->

<!--        .input-area { padding: 20px; border-top: 1px solid #eee; display: flex; gap: 10px; }-->
<!--        .input-area input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }-->
<!--        .input-area button { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: background 0.3s; }-->
<!--        .input-area button:hover { background: #5568d3; }-->
<!--        .input-area button:disabled { background: #ccc; cursor: not-allowed; }-->

<!--        .file-upload { display: flex; gap: 10px; padding: 20px; border-top: 1px solid #eee; }-->
<!--        .file-upload input[type="file"] { flex: 1; }-->
<!--        .file-upload button { padding: 12px 24px; background: #764ba2; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }-->

<!--        /* Timeline Section */-->
<!--        .timeline-section { background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; }-->
<!--        .timeline-header { padding: 20px; background: #764ba2; color: white; }-->
<!--        .timeline-header h2 { font-size: 20px; }-->

<!--        .timeline-container { flex: 1; overflow-y: auto; padding: 20px; }-->
<!--        .timeline-item { position: relative; padding-left: 30px; padding-bottom: 30px; border-left: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }-->
<!--        .timeline-item:hover { background: #f9f9f9; margin-left: -10px; padding-left: 40px; }-->
<!--        .timeline-item:last-child { border-left: none; }-->

<!--        .timeline-dot { position: absolute; left: -6px; top: 0; width: 12px; height: 12px; background: #667eea; border-radius: 50%; }-->
<!--        .timeline-date { font-size: 12px; color: #999; margin-bottom: 5px; }-->
<!--        .timeline-title { font-weight: 600; color: #333; margin-bottom: 5px; }-->
<!--        .timeline-summary { font-size: 14px; color: #666; }-->
<!--        .timeline-category { display: inline-block; margin-top: 5px; padding: 3px 8px; background: #e8eaf6; color: #667eea; border-radius: 4px; font-size: 12px; }-->

<!--        .timeline-details { display: none; margin-top: 10px; padding: 15px; background: #f5f7fa; border-radius: 8px; font-size: 14px; color: #555; line-height: 1.6; }-->
<!--        .timeline-item.expanded .timeline-details { display: block; }-->

<!--        .empty-timeline { text-align: center; padding: 40px; color: #999; }-->

<!--        .loading { display: flex; gap: 5px; padding: 20px; }-->
<!--        .loading span { width: 8px; height: 8px; background: #667eea; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }-->
<!--        .loading span:nth-child(1) { animation-delay: -0.32s; }-->
<!--        .loading span:nth-child(2) { animation-delay: -0.16s; }-->

<!--        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }-->

<!--        @media (max-width: 1024px) {-->
<!--            .container { grid-template-columns: 1fr; height: auto; }-->
<!--            .timeline-section { height: 500px; }-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--    <div class="container">-->
<!--        &lt;!&ndash; Chat Section &ndash;&gt;-->
<!--        <div class="chat-section">-->
<!--            <div class="chat-header">-->
<!--                <h1>AI Referral & Coordination</h1>-->
<!--                <p>Let's collect your information and medical history</p>-->
<!--            </div>-->

<!--            <div class="messages" id="messages">-->
<!--                <div class="message bot">-->
<!--                    Hello! I'm here to help you with your referral. Let's start by collecting some basic information. What is your full name?-->
<!--                </div>-->
<!--            </div>-->

<!--            <div class="input-area">-->
<!--                <input type="text" id="messageInput" placeholder="Type your message..." />-->
<!--                <button id="sendBtn">Send</button>-->
<!--            </div>-->

<!--            <div class="file-upload" id="fileUploadSection" style="display: none;">-->
<!--                <input type="file" id="fileInput" accept=".pdf" />-->
<!--                <button id="uploadBtn">Upload Document</button>-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Timeline Section &ndash;&gt;-->
<!--        <div class="timeline-section">-->
<!--            <div class="timeline-header">-->
<!--                <h2>Medical Timeline</h2>-->
<!--            </div>-->

<!--            <div class="timeline-container" id="timeline">-->
<!--                <div class="empty-timeline">Timeline will appear here once information is collected</div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <script>-->
<!--        const sessionId = 'session_' + Date.now();-->
<!--        let patientId = null;-->

<!--        const messages = document.getElementById('messages');-->
<!--        const messageInput = document.getElementById('messageInput');-->
<!--        const sendBtn = document.getElementById('sendBtn');-->
<!--        const fileUploadSection = document.getElementById('fileUploadSection');-->
<!--        const fileInput = document.getElementById('fileInput');-->
<!--        const uploadBtn = document.getElementById('uploadBtn');-->
<!--        const timeline = document.getElementById('timeline');-->

<!--        function addMessage(text, isUser = false) {-->
<!--            const div = document.createElement('div');-->
<!--            div.className = `message ${isUser ? 'user' : 'bot'}`;-->
<!--            div.textContent = text;-->
<!--            messages.appendChild(div);-->
<!--            messages.scrollTop = messages.scrollHeight;-->
<!--        }-->

<!--        function addLoading() {-->
<!--            const div = document.createElement('div');-->
<!--            div.className = 'loading';-->
<!--            div.innerHTML = '<span></span><span></span><span></span>';-->
<!--            messages.appendChild(div);-->
<!--            messages.scrollTop = messages.scrollHeight;-->
<!--            return div;-->
<!--        }-->

<!--        function updateTimeline(events) {-->
<!--            if (!events || events.length === 0) return;-->

<!--            timeline.innerHTML = '';-->
<!--            events.forEach(event => {-->
<!--                const item = document.createElement('div');-->
<!--                item.className = 'timeline-item';-->
<!--                item.innerHTML = `-->
<!--                    <div class="timeline-dot"></div>-->
<!--                    <div class="timeline-date">${event.date}</div>-->
<!--                    <div class="timeline-title">${event.title}</div>-->
<!--                    <div class="timeline-summary">${event.summary}</div>-->
<!--                    <span class="timeline-category">${event.category}</span>-->
<!--                    <div class="timeline-details">${event.details}</div>-->
<!--                `;-->

<!--                item.addEventListener('click', () => {-->
<!--                    item.classList.toggle('expanded');-->
<!--                });-->

<!--                timeline.appendChild(item);-->
<!--            });-->
<!--        }-->

<!--        async function sendMessage() {-->
<!--            const message = messageInput.value.trim();-->
<!--            if (!message) return;-->

<!--            addMessage(message, true);-->
<!--            messageInput.value = '';-->
<!--            sendBtn.disabled = true;-->

<!--            const loading = addLoading();-->

<!--            try {-->
<!--                const formData = new FormData();-->
<!--                formData.append('message', message);-->
<!--                formData.append('session_id', sessionId);-->
<!--                if (patientId) {-->
<!--                    formData.append('patient_id', patientId.toString());-->
<!--                }-->

<!--                console.log('Sending message:', message, 'Session:', sessionId, 'Patient:', patientId);-->

<!--                const response = await fetch('/api/referral/chat', {-->
<!--                    method: 'POST',-->
<!--                    body: formData-->
<!--                });-->

<!--                if (!response.ok) {-->
<!--                    const errorText = await response.text();-->
<!--                    console.error('Server error:', errorText);-->
<!--                    throw new Error(`Server error: ${response.status}`);-->
<!--                }-->

<!--                const data = await response.json();-->
<!--                console.log('Response:', data);-->

<!--                loading.remove();-->

<!--                addMessage(data.response);-->

<!--                if (data.patient_id) {-->
<!--                    patientId = data.patient_id;-->
<!--                    console.log('Patient ID set:', patientId);-->
<!--                }-->

<!--                if (data.input_type === 'text_or_file') {-->
<!--                    fileUploadSection.style.display = 'flex';-->
<!--                }-->

<!--                if (data.timeline) {-->
<!--                    updateTimeline(data.timeline);-->
<!--                }-->

<!--            } catch (error) {-->
<!--                loading.remove();-->
<!--                addMessage('Sorry, there was an error. Please try again.');-->
<!--                console.error('Error:', error);-->
<!--            } finally {-->
<!--                sendBtn.disabled = false;-->
<!--            }-->
<!--        }-->

<!--        async function uploadDocument() {-->
<!--            const file = fileInput.files[0];-->
<!--            if (!file) {-->
<!--                alert('Please select a file');-->
<!--                return;-->
<!--            }-->

<!--            if (!patientId) {-->
<!--                alert('Please complete registration first');-->
<!--                return;-->
<!--            }-->

<!--            addMessage('Uploading document...', true);-->
<!--            uploadBtn.disabled = true;-->

<!--            const loading = addLoading();-->

<!--            try {-->
<!--                const formData = new FormData();-->
<!--                formData.append('file', file);-->
<!--                formData.append('patient_id', patientId);-->
<!--                formData.append('session_id', sessionId);-->

<!--                const response = await fetch('/api/referral/upload', {-->
<!--                    method: 'POST',-->
<!--                    body: formData-->
<!--                });-->

<!--                const data = await response.json();-->
<!--                loading.remove();-->

<!--                addMessage(data.response);-->

<!--                if (data.timeline) {-->
<!--                    updateTimeline(data.timeline);-->
<!--                }-->

<!--                fileInput.value = '';-->

<!--            } catch (error) {-->
<!--                loading.remove();-->
<!--                addMessage('Error uploading document. Please try again.');-->
<!--                console.error(error);-->
<!--            } finally {-->
<!--                uploadBtn.disabled = false;-->
<!--            }-->
<!--        }-->

<!--        sendBtn.addEventListener('click', sendMessage);-->
<!--        messageInput.addEventListener('keypress', (e) => {-->
<!--            if (e.key === 'Enter') sendMessage();-->
<!--        });-->
<!--        uploadBtn.addEventListener('click', uploadDocument);-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Medilligence â€¢ Patient Referral</title>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: "Segoe UI", system-ui, sans-serif;
    background: #f4f7fb;
}

/* Layout */
.container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 20px;
    height: 100vh;
}

/* Chat Section */
.chat-section {
    display: flex;
    flex-direction: column;
    background: white;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    overflow: hidden;
}

/* Header */
.chat-header {
    padding: 18px 24px;
    background: #2563eb;
    color: white;
}
.chat-header h1 {
    font-size: 20px;
    font-weight: 600;
}
.chat-header p {
    font-size: 13px;
    opacity: 0.9;
}

/* Messages */
.messages {
    flex: 1;
    padding: 22px;
    background: #f9fafb;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.message {
    max-width: 75%;
    padding: 12px 16px;
    border-radius: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.message.bot {
    background: #eef2f7;
    color: #1f2937;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.message.user {
    background: #2563eb;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

/* Input Bar */
.input-area {
    padding: 14px 18px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    gap: 10px;
    background: white;
}

.input-area input {
    flex: 1;
    padding: 12px 16px;
    border-radius: 22px;
    border: 1px solid #d1d5db;
    font-size: 14px;
}

.icon-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #e0e7ff;
    border: none;
    font-size: 18px;
    color: #2563eb;
    cursor: pointer;

    display: flex;
    align-items: center;
    justify-content: center;
}

.send-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #2563eb;
    border: none;
    color: white;
    font-size: 16px;
    cursor: pointer;

    display: flex;
    align-items: center;
    justify-content: center;
}

/* Upload area (logic preserved, UI hidden) */
.file-upload {
    display: none;
}

/* Timeline Section â€” UNCHANGED */
.timeline-section {
    background: white;
    border-radius: 16px;
    box-shadow: 0 18px 40px rgba(0,0,0,0.12);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.timeline-header {
    padding: 18px 20px;
    background: #2563eb;
    color: white;
}

.timeline-header h2 {
    font-size: 18px;
}

.timeline-container {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Responsive */
@media (max-width: 1024px) {
    .container {
        grid-template-columns: 1fr;
        height: auto;
    }
    .timeline-section {
        height: 500px;
    }
}
</style>
</head>

<body>

<div class="container">

    <!-- Chat Section -->
    <div class="chat-section">

        <div class="chat-header">
            <h1>Medilligence</h1>
            <p>Patient Referral & Care Coordination</p>
        </div>

        <div class="messages" id="messages">
            <div class="message bot">
                Hello! I'm here to help you with your referral. Let's start by collecting some basic information. What is your full name?
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Type your message..." />
            <button class="icon-btn" onclick="document.getElementById('fileInput').click()">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-paperclip" viewBox="0 0 16 16">
  <path d="M4.5 3a2.5 2.5 0 0 1 5 0v9a1.5 1.5 0 0 1-3 0V5a.5.5 0 0 1 1 0v7a.5.5 0 0 0 1 0V3a1.5 1.5 0 1 0-3 0v9a2.5 2.5 0 0 0 5 0V5a.5.5 0 0 1 1 0v7a3.5 3.5 0 1 1-7 0z"/>
</svg>
            </button>
            <button class="send-btn" id="sendBtn">âž¤</button>
        </div>

        <!-- Upload logic (UNCHANGED) -->
        <div class="file-upload" id="fileUploadSection">
            <input type="file" id="fileInput" accept=".pdf" />
            <button id="uploadBtn">Upload</button>
        </div>

    </div>

    <!-- Timeline Section (UNCHANGED) -->
    <div class="timeline-section">
        <div class="timeline-header">
            <h2>Medical Timeline</h2>
        </div>

        <div class="timeline-container" id="timeline">
            <div class="empty-timeline">
                Timeline will appear here once information is collected
            </div>
        </div>
    </div>

</div>

<!-- ðŸ”’ JS BELOW IS COPIED VERBATIM â€” UNCHANGED -->
<script>
    const sessionId = 'session_' + Date.now();
        let patientId = null;

        const messages = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const fileUploadSection = document.getElementById('fileUploadSection');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const timeline = document.getElementById('timeline');

        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user' : 'bot'}`;
            div.textContent = text;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        function addLoading() {
            const div = document.createElement('div');
            div.className = 'loading';
            div.innerHTML = '<span></span><span></span><span></span>';
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
            return div;
        }

        function updateTimeline(events) {
            if (!events || events.length === 0) return;

            timeline.innerHTML = '';
            events.forEach(event => {
                const item = document.createElement('div');
                item.className = 'timeline-item';
                item.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="timeline-date">${event.date}</div>
                    <div class="timeline-title">${event.title}</div>
                    <div class="timeline-summary">${event.summary}</div>
                    <span class="timeline-category">${event.category}</span>
                    <div class="timeline-details">${event.details}</div>
                `;

                item.addEventListener('click', () => {
                    item.classList.toggle('expanded');
                });

                timeline.appendChild(item);
            });
        }

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            addMessage(message, true);
            messageInput.value = '';
            sendBtn.disabled = true;

            const loading = addLoading();

            try {
                const formData = new FormData();
                formData.append('message', message);
                formData.append('session_id', sessionId);
                if (patientId) {
                    formData.append('patient_id', patientId.toString());
                }

                console.log('Sending message:', message, 'Session:', sessionId, 'Patient:', patientId);

                const response = await fetch('/api/referral/chat', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();
                console.log('Response:', data);

                loading.remove();

                addMessage(data.response);

                if (data.patient_id) {
                    patientId = data.patient_id;
                    console.log('Patient ID set:', patientId);
                }

                if (data.input_type === 'text_or_file') {
                    fileUploadSection.style.display = 'flex';
                }

                if (data.timeline) {
                    updateTimeline(data.timeline);
                }

            } catch (error) {
                loading.remove();
                addMessage('Sorry, there was an error. Please try again.');
                console.error('Error:', error);
            } finally {
                sendBtn.disabled = false;
            }
        }

        async function uploadDocument() {
            const file = fileInput.files[0];
            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!patientId) {
                alert('Please complete registration first');
                return;
            }

            addMessage('Uploading document...', true);
            uploadBtn.disabled = true;

            const loading = addLoading();

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('patient_id', patientId);
                formData.append('session_id', sessionId);

                const response = await fetch('/api/referral/upload', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                loading.remove();

                addMessage(data.response);

                if (data.timeline) {
                    updateTimeline(data.timeline);
                }

                fileInput.value = '';

            } catch (error) {
                loading.remove();
                addMessage('Error uploading document. Please try again.');
                console.error(error);
            } finally {
                uploadBtn.disabled = false;
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        uploadBtn.addEventListener('click', uploadDocument);
</script>

</body>
</html>
